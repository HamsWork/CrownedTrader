{% extends 'signals/base.html' %}
{% load static %}

{% block title %}Position Management - Crowned Trader{% endblock %}

{% block extra_css %}
<style>
  .pm-page {
    width: 100%;
    max-width: 1840px;
    margin: 0 auto;
  }

  .pm-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 20px;
    margin-bottom: 24px;
  }

  .pm-title h1 {
    color: #e8ecff;
    font-size: 2.2em;
    font-weight: 800;
    margin: 0 0 10px 0;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .pm-title p {
    margin: 0;
    color: rgba(232, 236, 255, 0.65);
    font-size: 1.05em;
    max-width: 880px;
  }

  .pm-tabs {
    display: inline-flex;
    gap: 8px;
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(42, 55, 95, 0.55);
    padding: 6px;
    border-radius: 14px;
    height: 44px;
  }

  .pm-tab {
    height: 32px;
    padding: 0 14px;
    border-radius: 12px;
    border: 1px solid transparent;
    background: transparent;
    color: rgba(232, 236, 255, 0.72);
    font-weight: 900;
    cursor: pointer;
  }

  .pm-tab.active {
    background: rgba(var(--accent-rgb), 0.92);
    color: #0b1020;
    border-color: rgba(var(--accent-rgb), 0.92);
  }

  .pm-table-wrap {
    background: rgba(15, 23, 42, 0.72);
    border: 1px solid rgba(42, 55, 95, 0.55);
    border-radius: 16px;
    overflow: hidden;
  }

  .pm-table {
    width: 100%;
    border-collapse: collapse;
  }

  .pm-table thead th {
    text-align: left;
    font-size: 12px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: rgba(232, 236, 255, 0.55);
    background: rgba(10, 16, 35, 0.55);
    padding: 14px 14px;
    border-bottom: 1px solid rgba(42, 55, 95, 0.55);
    white-space: nowrap;
  }

  .pm-table tbody td {
    padding: 14px 14px;
    border-bottom: 1px solid rgba(42, 55, 95, 0.35);
    color: rgba(232, 236, 255, 0.84);
    vertical-align: middle;
    white-space: nowrap;
  }

  .pm-table tbody tr:hover td {
    background: rgba(255, 255, 255, 0.03);
  }

  .pm-sym {
    font-weight: 900;
    color: #e8ecff;
    letter-spacing: 0.02em;
  }

  .pm-sub {
    display: block;
    margin-top: 4px;
    color: rgba(232, 236, 255, 0.55);
    font-size: 12px;
    white-space: normal;
  }

  .pm-pill {
    display: inline-flex;
    align-items: center;
    height: 22px;
    padding: 0 10px;
    border-radius: 999px;
    border: 1px solid rgba(42, 55, 95, 0.55);
    background: rgba(10, 16, 35, 0.50);
    color: rgba(232, 236, 255, 0.78);
    font-size: 12px;
    font-weight: 800;
  }

  .pm-pill.good {
    border-color: rgba(16, 185, 129, 0.35);
    color: rgba(52, 211, 153, 0.95);
  }

  .pm-pill.bad {
    border-color: rgba(248, 113, 113, 0.35);
    color: rgba(248, 113, 113, 0.95);
  }

  .pm-action {
    height: 34px;
    padding: 0 12px;
    border-radius: 12px;
    border: 1px solid rgba(42, 55, 95, 0.75);
    background: rgba(255, 255, 255, 0.04);
    color: rgba(232, 236, 255, 0.9);
    font-weight: 900;
    cursor: pointer;
  }

  .pm-action:hover {
    background: rgba(255, 255, 255, 0.06);
    border-color: rgba(42, 55, 95, 0.95);
  }

  .pm-manual-exit-input {
    width: 120px;
    height: 34px;
    padding: 0 12px;
    border-radius: 12px;
    border: 1px solid rgba(42, 55, 95, 0.75);
    background: rgba(255, 255, 255, 0.04);
    color: rgba(232, 236, 255, 0.9);
    font-weight: 700;
    font-size: 14px;
  }

  .pm-manual-exit-input::placeholder {
    color: rgba(232, 236, 255, 0.4);
  }

  .pm-manual-exit-input:read-only {
    cursor: default;
    background: rgba(42, 55, 95, 0.35);
  }

  .pm-empty {
    padding: 18px;
    color: rgba(232, 236, 255, 0.70);
  }

  .pm-pagination {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 16px;
    border-top: 1px solid rgba(42, 55, 95, 0.55);
    background: rgba(10, 16, 35, 0.55);
    flex-wrap: wrap;
  }
  .pm-pagination-link {
    color: rgba(var(--accent-rgb), 0.95);
    text-decoration: none;
    font-weight: 700;
    padding: 6px 12px;
    border-radius: 8px;
    border: 1px solid rgba(42, 55, 95, 0.55);
  }
  .pm-pagination-link:hover {
    background: rgba(255, 255, 255, 0.06);
    border-color: rgba(var(--accent-rgb), 0.5);
  }
  .pm-pagination-info {
    color: rgba(232, 236, 255, 0.72);
    font-size: 14px;
  }

  .pm-modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(3, 7, 18, 0.72);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
    z-index: 1200;
  }

  .pm-modal {
    width: 100%;
    max-width: 720px;
    background: rgba(15, 23, 42, 0.96);
    border: 1px solid rgba(42, 55, 95, 0.75);
    border-radius: 18px;
    box-shadow: 0 20px 80px rgba(0, 0, 0, 0.55);
    overflow: hidden;
  }

  .pm-modal-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 16px;
    border-bottom: 1px solid rgba(42, 55, 95, 0.55);
    background: rgba(10, 16, 35, 0.55);
  }

  .pm-modal-title {
    color: #e8ecff;
    font-weight: 900;
    font-size: 16px;
    letter-spacing: 0.02em;
  }

  .pm-modal-close {
    height: 34px;
    width: 34px;
    border-radius: 12px;
    border: 1px solid rgba(42, 55, 95, 0.75);
    background: rgba(255, 255, 255, 0.04);
    color: rgba(232, 236, 255, 0.9);
    cursor: pointer;
    font-weight: 900;
  }

  .pm-modal-body {
    padding: 16px;
  }

  .pm-modal-row {
    display: flex;
    gap: 14px;
    flex-wrap: wrap;
    margin-bottom: 14px;
  }

  .pm-radio {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: 14px;
    border: 1px solid rgba(42, 55, 95, 0.75);
    background: rgba(255, 255, 255, 0.03);
    cursor: pointer;
    color: rgba(232, 236, 255, 0.88);
    font-weight: 900;
  }

  .pm-radio input {
    accent-color: rgba(var(--accent-rgb), 0.92);
  }

  .pm-current-price-input-row {
    align-items: center;
    gap: 12px;
    margin-top: 6px;
  }

  .pm-exit-manual-switch {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    user-select: none;
    color: rgba(232, 236, 255, 0.84);
    font-size: 13px;
    font-weight: 600;
  }

  .pm-exit-manual-switch input {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
  }

  .pm-exit-manual-slider {
    position: relative;
    display: inline-block;
    width: 40px;
    height: 22px;
    background: rgba(42, 55, 95, 0.55);
    border-radius: 11px;
    transition: background 0.2s;
  }

  .pm-exit-manual-slider::before {
    content: '';
    position: absolute;
    width: 18px;
    height: 18px;
    left: 2px;
    top: 2px;
    background: rgba(232, 236, 255, 0.9);
    border-radius: 50%;
    transition: transform 0.2s;
  }

  .pm-exit-manual-switch input:checked + .pm-exit-manual-slider {
    background: rgba(var(--accent-rgb), 0.7);
  }

  .pm-exit-manual-switch input:checked + .pm-exit-manual-slider::before {
    transform: translateX(18px);
  }

  .pm-exit-manual-label {
    white-space: nowrap;
  }

  .pm-modal-label {
    color: rgba(232, 236, 255, 0.65);
    font-weight: 900;
    font-size: 12px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    margin: 0 0 8px 0;
  }

  /* Discord embed preview (same structure as Post a trade preview) */
  .discord-embed {
    display: flex;
    background: rgba(10, 16, 35, 0.72);
    border-radius: 4px;
    max-width: 100%;
    overflow: hidden;
    border: 1px solid rgba(42, 55, 95, 0.55);
  }

  .discord-embed-color-bar {
    width: 4px;
    background: #202225;
    flex-shrink: 0;
  }

  .discord-embed-content {
    padding: 12px 14px;
    flex-grow: 1;
    min-width: 0;
  }

  .discord-embed-title {
    font-weight: 600;
    font-size: 1em;
    color: #dcddde;
    margin-bottom: 8px;
    line-height: 1.2;
  }

  .discord-embed-title:empty {
    display: none;
  }

  .discord-embed-fields {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 10px;
  }

  .discord-embed-fields-row {
    display: flex;
    flex-wrap: nowrap;
    gap: 12px;
    min-width: 0;
  }

  .discord-embed-field {
    flex: 1 1 0;
    min-width: 0;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    text-align: left;
  }

  .discord-embed-field-name {
    color: #ffffff;
    font-weight: 600;
    font-size: 0.85em;
    margin-bottom: 2px;
    word-wrap: break-word;
    width: 100%;
    text-align: left;
  }

  .discord-embed-field-value {
    color: #dcddde;
    font-size: 0.95em;
    word-wrap: break-word;
    width: 100%;
    text-align: left;
  }

  .discord-embed-description {
    font-size: 0.95em;
    color: #dcddde;
    line-height: 1.3;
    margin-bottom: 8px;
    word-wrap: break-word;
    white-space: pre-wrap;
  }

  .discord-embed-description:empty {
    display: none;
  }
  #pmPreviewDescriptionAfter {
    margin-top: 10px;
  }

  .discord-embed-footer {
    font-size: 0.95em;
    color: #dcddde;
    margin-top: 10px;
    line-height: 1.3;
  }

  .discord-embed-footer:empty {
    display: none;
  }

  .discord-embed-title strong,
  .discord-embed-description strong {
    font-weight: 600;
  }

  .discord-embed-title em,
  .discord-embed-description em {
    font-style: italic;
  }

  .discord-embed-title u,
  .discord-embed-description u {
    text-decoration: underline;
  }

  .discord-embed-title s,
  .discord-embed-description s {
    text-decoration: line-through;
  }

  .discord-embed-title code,
  .discord-embed-description code {
    background: rgba(0, 0, 0, 0.3);
    padding: 2px 4px;
    border-radius: 3px;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 0.9em;
  }

  .discord-embed-title pre,
  .discord-embed-description pre {
    background: rgba(0, 0, 0, 0.3);
    padding: 8px;
    border-radius: 4px;
    margin: 4px 0;
    overflow-x: auto;
  }

  .discord-embed-title pre code,
  .discord-embed-description pre code {
    background: none;
    padding: 0;
  }

  .pm-modal-foot {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    padding: 14px 16px;
    border-top: 1px solid rgba(42, 55, 95, 0.55);
    background: rgba(10, 16, 35, 0.35);
  }

  .pm-param-form .pm-param-group {
    margin-bottom: 20px;
  }
  .pm-param-form .pm-param-label {
    display: block;
    font-size: 13px;
    font-weight: 700;
    color: rgba(232, 236, 255, 0.9);
    margin-bottom: 8px;
    letter-spacing: 0.02em;
  }
  .pm-param-form .pm-param-input,
  .pm-param-form .pm-param-select {
    width: 100%;
    box-sizing: border-box;
    height: 40px;
    padding: 0 14px;
    border-radius: 12px;
    border: 1px solid rgba(42, 55, 95, 0.65);
    background: rgba(255, 255, 255, 0.05);
    color: #e8ecff;
    font-size: 14px;
    font-weight: 600;
    transition: border-color 0.2s, background 0.2s;
  }
  .pm-param-form .pm-param-input::placeholder {
    color: rgba(232, 236, 255, 0.4);
  }
  .pm-param-form .pm-param-input:focus {
    outline: none;
    border-color: rgba(var(--accent-rgb), 0.6);
    background: rgba(255, 255, 255, 0.07);
  }
  /* Dropdown style to match Post a trade (dashboard .form-select) */
  .pm-param-form .pm-param-select {
    cursor: pointer;
    appearance: none;
    padding: 12px 15px;
    padding-right: 40px;
    height: auto;
    min-height: 44px;
    background: rgba(10, 16, 35, 0.72);
    color: #e0e0e0;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23888' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    font-size: 1em;
    transition: all 0.3s;
  }
  .pm-param-form .pm-param-select:focus {
    outline: none;
    border-color: rgba(var(--accent-rgb), 0.6);
    background-color: rgba(10, 16, 35, 0.85);
  }
  .pm-param-form .pm-param-select:hover {
    border-color: rgba(42, 55, 95, 0.9);
  }
  .pm-param-form .pm-param-select option {
    background: #050816;
    color: #e0e0e0;
  }
  .pm-param-form .pm-param-row {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
  }
  .pm-param-form .pm-param-row .pm-param-input {
    flex: 1;
    min-width: 0;
  }
  .pm-param-form .pm-param-row .pm-param-value {
    font-size: 13px;
    color: rgba(232, 236, 255, 0.65);
  }
  .pm-param-form .pm-param-custom {
    margin-top: 12px;
    padding: 12px;
    border-radius: 12px;
    background: rgba(42, 55, 95, 0.25);
    border: 1px solid rgba(42, 55, 95, 0.4);
  }
  .pm-param-form .pm-param-custom .pm-param-label {
    margin-bottom: 6px;
    font-size: 12px;
    color: rgba(232, 236, 255, 0.75);
  }
  .pm-param-form .pm-param-custom .pm-param-input {
    margin-bottom: 8px;
  }
  .pm-param-form .pm-param-custom .pm-param-input:last-of-type {
    margin-bottom: 0;
  }
  /* Percent input with % suffix */
  .pm-param-form .pm-param-percent-wrapper {
    position: relative;
    width: 100%;
  }
  .pm-param-form .pm-param-percent-wrapper .pm-param-input {
    padding-right: 40px;
  }
  .pm-param-form .pm-param-percent-suffix {
    position: absolute;
    right: 14px;
    top: 50%;
    transform: translateY(-50%);
    color: rgba(232, 236, 255, 0.7);
    font-size: 14px;
    font-weight: 600;
    pointer-events: none;
    user-select: none;
  }

  .pm-hidden {
    display: none;
  }
</style>
{% endblock %}

{% block breadcrumbs %}
<span>Position Management</span>
{% endblock %}

{% block content %}
<div class="pm-page">
  <div class="pm-header">
    <div class="pm-title">
      <h1>Position Management</h1>
      <p>Track open and closed positions with a clean, exchange-style P/L view.</p>
    </div>
    <div class="pm-tabs" role="tablist">
      <button class="pm-tab active" type="button" data-tab="open">Open ({{ open_page.paginator.count }})</button>
      <button class="pm-tab" type="button" data-tab="closed">Closed ({{ closed_page.paginator.count }})</button>
    </div>
  </div>

  <div id="tab-open" class="pm-table-wrap">
    {% if open_positions %}
    <table class="pm-table">
      <thead>
        <tr>
          <th>Symbol</th>
          <th>Qty</th>
          <th>Closed</th>
          <th>Entry</th>
          <th>Mark</th>
          <th>Status</th>
          <th>P/L %</th>
          <th>Realized P/L %</th>
          <th>Opened</th>
          <th>Track Mode</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for p in open_positions %}
        <tr data-position-id="{{ p.id }}">
          <td>
            <span class="pm-sym">{{ p.symbol|default:"-" }}</span>
            {% if p.instrument == "options" %}
              <span class="pm-sub">{{ p.option_type }} {{ p.strike }} Â· {{ p.expiration }}</span>
            {% elif p.instrument == "shares" %}
              <span class="pm-sub">Shares</span>
            {% endif %}
          </td>
          <td>{{ p.display_qty }}</td>
          <td>
            {% if p.closed_units and p.closed_units > 0 %}
              {{ p.closed_units }} ({{ p.closed_pct|floatformat:0 }}%)
            {% else %}
              -
            {% endif %}
          </td>
          <td>${{ p.entry_str }}</td>
          <td class="pm-live-mark">${{ p.mark_str }}</td>
          <td>
            <span class="pm-pill pm-live-status {% if p.status_kind == 'good' %}good{% elif p.status_kind == 'bad' %}bad{% endif %}">
              {{ p.status_label }}
            </span>
          </td>
          <td>
            <span class="pm-pill pm-live-pnl {% if p.pnl_pct > 0 %}good{% elif p.pnl_pct < 0 %}bad{% endif %}">
              {{ p.pnl_pct_str }}
            </span>
          </td>
          <td>
            <span class="pm-pill pm-live-realized-pnl {% if p.realized_pnl_pct > 0 %}good{% elif p.realized_pnl_pct < 0 %}bad{% endif %}">
              {{ p.realized_pnl_pct_str }}
            </span>
          </td>
          <td>{{ p.opened_at|date:"M d, Y H:i" }}</td>
          <td>
            <span class="pm-pill">{{ p.mode_label }}</span>
          </td>
          <td style="text-align:right;">
            {% if p.mode == "auto" %}
            <button class="pm-action" type="button" data-mode="{{ p.id }}" data-mode-to="manual">Switch to manual</button>
            {% else %}
            <textarea class="pm-hidden" data-preview-tp-for="{{ p.id }}">{{ p.preview_tp_embed }}</textarea>
            <textarea class="pm-hidden" data-preview-tp-partial-for="{{ p.id }}">{{ p.preview_tp_partial_embed }}</textarea>
            <textarea class="pm-hidden" data-preview-sl-for="{{ p.id }}">{{ p.preview_sl_embed }}</textarea>
            <button class="pm-action" type="button" data-partial-exit="{{ p.id }}" data-partial-symbol="{{ p.symbol|default:'' }}" data-partial-entry="{{ p.entry_str|default:'' }}" data-partial-qty="{{ p.display_qty|default:'' }}" data-partial-mark="{{ p.mark_str|default:'' }}" data-takeoff-percent="{{ p.current_takeoff_percent|default:'' }}" data-next-target-percent="{{ p.next_target_percent|default:'' }}" data-next-target-value="{{ p.next_target_value|default:'' }}" data-raise-sl-to="{{ p.current_raise_sl_to|default:'off' }}" data-raise-sl-custom-per="{{ p.current_raise_sl_custom_per|default:'' }}" data-raise-sl-custom-price="{{ p.current_raise_sl_custom_price|default:'' }}" data-raise-sl-custom-stock="{{ p.current_raise_sl_custom_stock|default:'' }}">Partial Exit</button>
            <button class="pm-action" type="button" data-post-exit="{{ p.id }}" data-exit-symbol="{{ p.symbol|default:'' }}" data-exit-entry="{{ p.entry_str|default:'' }}">Full Exit</button>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% if open_page.has_other_pages %}
    <div class="pm-pagination">
      {% if open_page.has_previous %}
        <a class="pm-pagination-link" href="?page=1{% if closed_page.number > 1 %}&closed_page={{ closed_page.number }}{% endif %}">First</a>
        <a class="pm-pagination-link" href="?page={{ open_page.previous_page_number }}{% if closed_page.number > 1 %}&closed_page={{ closed_page.number }}{% endif %}">Previous</a>
      {% endif %}
      <span class="pm-pagination-info">Page {{ open_page.number }} of {{ open_page.paginator.num_pages }}</span>
      {% if open_page.has_next %}
        <a class="pm-pagination-link" href="?page={{ open_page.next_page_number }}{% if closed_page.number > 1 %}&closed_page={{ closed_page.number }}{% endif %}">Next</a>
        <a class="pm-pagination-link" href="?page={{ open_page.paginator.num_pages }}{% if closed_page.number > 1 %}&closed_page={{ closed_page.number }}{% endif %}">Last</a>
      {% endif %}
    </div>
    {% endif %}
    {% else %}
      <div class="pm-empty">No open positions yet.</div>
    {% endif %}
  </div>

  <div id="tab-closed" class="pm-table-wrap" style="display:none; margin-top: 18px;">
    {% if closed_positions %}
    <table class="pm-table">
      <thead>
        <tr>
          <th>Symbol</th>
          <th>Qty</th>
          <th>Entry</th>
          <th>Exit</th>
          <th>Status</th>
          <th>Realized P/L %</th>
          <th>Closed</th>
        </tr>
      </thead>
      <tbody>
        {% for p in closed_positions %}
        <tr>
          <td>
            <span class="pm-sym">{{ p.symbol|default:"-" }}</span>
            {% if p.instrument == "options" %}
              <span class="pm-sub">{{ p.option_type }} {{ p.strike }} Â· {{ p.expiration }}</span>
            {% elif p.instrument == "shares" %}
              <span class="pm-sub">Shares</span>
            {% endif %}
          </td>
          <td>{{ p.display_qty }}</td>
          <td>${{ p.entry_str }}</td>
          <td>${{ p.exit_str }}</td>
          <td><span class="pm-pill">Closed</span></td>
          <td>
            <span class="pm-pill {% if p.pnl_pct > 0 %}good{% elif p.pnl_pct < 0 %}bad{% endif %}">
              {{ p.pnl_pct_str }}
            </span>
          </td>
          <td>{{ p.closed_at|date:"M d, Y H:i" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% if closed_page.has_other_pages %}
    <div class="pm-pagination">
      {% if closed_page.has_previous %}
        <a class="pm-pagination-link" href="?closed_page=1{% if open_page.number > 1 %}&page={{ open_page.number }}{% endif %}">First</a>
        <a class="pm-pagination-link" href="?closed_page={{ closed_page.previous_page_number }}{% if open_page.number > 1 %}&page={{ open_page.number }}{% endif %}">Previous</a>
      {% endif %}
      <span class="pm-pagination-info">Page {{ closed_page.number }} of {{ closed_page.paginator.num_pages }}</span>
      {% if closed_page.has_next %}
        <a class="pm-pagination-link" href="?closed_page={{ closed_page.next_page_number }}{% if open_page.number > 1 %}&page={{ open_page.number }}{% endif %}">Next</a>
        <a class="pm-pagination-link" href="?closed_page={{ closed_page.paginator.num_pages }}{% if open_page.number > 1 %}&page={{ open_page.number }}{% endif %}">Last</a>
      {% endif %}
    </div>
    {% endif %}
    {% else %}
      <div class="pm-empty">No closed positions yet.</div>
    {% endif %}
  </div>
</div>

<div class="pm-modal-backdrop" id="pmExitBackdrop" aria-hidden="true">
  <div class="pm-modal" role="dialog" aria-modal="true" aria-label="Full Exit">
    <div class="pm-modal-head">
      <div class="pm-modal-title">Full Exit</div>
      <button class="pm-modal-close" type="button" data-exit-close>âœ•</button>
    </div>
    <div class="pm-modal-body">
      <div class="pm-modal-row">
        <label class="pm-radio">
          <input type="radio" name="pmExitKind" value="tp" checked />
          <span>Take Profit</span>
        </label>
        <label class="pm-radio">
          <input type="radio" name="pmExitKind" value="sl" />
          <span>Stop Loss</span>
        </label>
      </div>
      <div class="pm-current-price-row">
        <div class="pm-modal-label">Current Price</div>
        <div class="pm-modal-row pm-current-price-input-row">
          <input type="number" id="pmCurrentPrice" class="pm-manual-exit-input" step="0.01" min="0" placeholder="0.00" />
          <label class="pm-exit-manual-switch">
            <input type="checkbox" id="pmUseManualPrice" aria-label="Use manual price" />
            <span class="pm-exit-manual-slider"></span>
            <span class="pm-exit-manual-label">Use Manual Price</span>
          </label>
        </div>
      </div>
      <div class="pm-modal-label">Discord Preview</div>
      <div class="discord-embed" id="pmDiscordPreviewEmbed">
        <div class="discord-embed-color-bar" id="pmPreviewColorBar"></div>
        <div class="discord-embed-content">
          <div class="discord-embed-title" id="pmPreviewTitle"></div>
          <div class="discord-embed-description" id="pmPreviewDescription"></div>
          <div class="discord-embed-fields" id="pmPreviewFields"></div>
          <div class="discord-embed-description" id="pmPreviewDescriptionAfter"></div>
          <div class="discord-embed-footer" id="pmPreviewFooter"></div>
        </div>
      </div>
    </div>
    <div class="pm-modal-foot">
      <button class="pm-action" type="button" data-exit-cancel>Cancel</button>
      <button class="pm-action" type="button" id="pmExitConfirm">Full Exit</button>
    </div>
  </div>
</div>

<div class="pm-modal-backdrop" id="pmPartialExitBackdrop" aria-hidden="true">
  <div class="pm-modal" role="dialog" aria-modal="true" aria-label="Partial Exit (Take Profit)">
    <div class="pm-modal-head">
      <div class="pm-modal-title">Partial Exit (Take Profit)</div>
      <button class="pm-modal-close" type="button" data-partial-exit-close>âœ•</button>
    </div>
    <div class="pm-modal-body">
      <div class="pm-current-price-row">
        <div class="pm-modal-label">Current Price</div>
        <div class="pm-modal-row pm-current-price-input-row">
          <input type="number" id="pmPartialCurrentPrice" class="pm-manual-exit-input" step="0.01" min="0" placeholder="0.00" />
          <label class="pm-exit-manual-switch">
            <input type="checkbox" id="pmPartialUseManualPrice" aria-label="Use manual price" />
            <span class="pm-exit-manual-slider"></span>
            <span class="pm-exit-manual-label">Use Manual Price</span>
          </label>
        </div>
      </div>
      <div class="pm-modal-label">Discord Preview</div>
      <div class="discord-embed" id="pmPartialDiscordPreviewEmbed">
        <div class="discord-embed-color-bar" id="pmPartialPreviewColorBar"></div>
        <div class="discord-embed-content">
          <div class="discord-embed-title" id="pmPartialPreviewTitle"></div>
          <div class="discord-embed-description" id="pmPartialPreviewDescription"></div>
          <div class="discord-embed-fields" id="pmPartialPreviewFields"></div>
          <div class="discord-embed-description" id="pmPartialPreviewDescriptionAfter"></div>
          <div class="discord-embed-footer" id="pmPartialPreviewFooter"></div>
        </div>
      </div>
    </div>
    <div class="pm-modal-foot">
      <button class="pm-action" type="button" id="pmPartialExitParameterBtn">Edit Parameter</button>
      <div style="margin-left: auto; display: flex; gap: 10px;">
        <button class="pm-action" type="button" data-partial-exit-cancel>Cancel</button>
        <button class="pm-action" type="button" id="pmPartialExitConfirm">Partial Exit</button>
      </div>
    </div>
  </div>
</div>

<div class="pm-modal-backdrop" id="pmExitParameterBackdrop" aria-hidden="true">
  <div class="pm-modal" role="dialog" aria-modal="true" aria-label="Edit Parameters">
    <div class="pm-modal-head">
      <div class="pm-modal-title">Edit Parameters</div>
      <button class="pm-modal-close" type="button" data-exit-parameter-close>âœ•</button>
    </div>
    <div class="pm-modal-body">
      <div id="pmExitParameterContent">
        <!-- Content will be populated based on exit type (full/partial) -->
      </div>
    </div>
    <div class="pm-modal-foot">
      <button class="pm-action" type="button" data-exit-parameter-cancel>Cancel</button>
      <button class="pm-action" type="button" id="pmExitParameterSave">Save</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function () {
  const tabs = Array.from(document.querySelectorAll('[data-tab]'));
  const openEl = document.getElementById('tab-open');
  const closedEl = document.getElementById('tab-closed');
  const exitBackdrop = document.getElementById('pmExitBackdrop');
  const previewColorBar = document.getElementById('pmPreviewColorBar');
  const previewTitle = document.getElementById('pmPreviewTitle');
  const previewDesc = document.getElementById('pmPreviewDescription');
  const previewFields = document.getElementById('pmPreviewFields');
  const previewDescAfter = document.getElementById('pmPreviewDescriptionAfter');
  const previewFooter = document.getElementById('pmPreviewFooter');
  const exitConfirmBtn = document.getElementById('pmExitConfirm');
  const exitKindEls = Array.from(document.querySelectorAll('input[name="pmExitKind"]'));
  let activeExitPositionId = null;

  const partialExitBackdrop = document.getElementById('pmPartialExitBackdrop');
  const partialCurrentPriceInput = document.getElementById('pmPartialCurrentPrice');
  const partialUseManualPriceSwitch = document.getElementById('pmPartialUseManualPrice');
  const partialPreviewTitle = document.getElementById('pmPartialPreviewTitle');
  const partialPreviewDesc = document.getElementById('pmPartialPreviewDescription');
  const partialPreviewFields = document.getElementById('pmPartialPreviewFields');
  const partialPreviewDescAfter = document.getElementById('pmPartialPreviewDescriptionAfter');
  const partialPreviewFooter = document.getElementById('pmPartialPreviewFooter');
  const partialPreviewColorBar = document.getElementById('pmPartialPreviewColorBar');
  const partialExitConfirmBtn = document.getElementById('pmPartialExitConfirm');
  let activePartialExitPositionId = null;
  let activePartialExitEntry = '';
  
  // Exit Parameter modal elements
  const exitParameterBackdrop = document.getElementById('pmExitParameterBackdrop');
  const exitParameterContent = document.getElementById('pmExitParameterContent');
  const exitParameterSaveBtn = document.getElementById('pmExitParameterSave');
  const exitParameterBtn = document.getElementById('pmExitParameterBtn');
  const partialExitParameterBtn = document.getElementById('pmPartialExitParameterBtn');
  
  // Exit parameter state
  let exitParameters = {
    reduce_percent: '',
    next_level: '',
    next_target_percent: '',
    next_target_value: '',
    raise_sl_to: 'off',
    raise_sl_custom_per: '',
    raise_sl_custom_price: '',
    raise_sl_custom_stock: ''
  };
  let partialLivePriceInterval = null;
  function setTab(name) {
    tabs.forEach((t) => t.classList.toggle('active', t.getAttribute('data-tab') === name));
    if (openEl) openEl.style.display = (name === 'open') ? '' : 'none';
    if (closedEl) closedEl.style.display = (name === 'closed') ? '' : 'none';
  }
  tabs.forEach((t) => t.addEventListener('click', () => setTab(t.getAttribute('data-tab'))));

  function getCookie(name) {
    const cookies = document.cookie ? document.cookie.split(';') : [];
    for (let i = 0; i < cookies.length; i++) {
      const c = cookies[i].trim();
      if (c.startsWith(name + '=')) return decodeURIComponent(c.substring(name.length + 1));
    }
    return '';
  }

  function getPreviewText(id, kind, partial) {
    let sel;
    if (kind === 'sl') sel = `[data-preview-sl-for="${id}"]`;
    else if (partial) sel = `[data-preview-tp-partial-for="${id}"]`;
    else sel = `[data-preview-tp-for="${id}"]`;
    const el = document.querySelector(sel);
    return el && typeof el.value === 'string' ? el.value : '';
  }

  function parseDiscordMarkdown(text) {
    if (!text) return '';
    let html = String(text).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
    const codeBlocks = [];
    html = html.replace(/`([^`\n]+)`/g, (match, code) => {
      const placeholder = `__CODE_BLOCK_${codeBlocks.length}__`;
      codeBlocks.push(`<code>${code}</code>`);
      return placeholder;
    });
    html = html.replace(/\*\*\*([^*]+)\*\*\*/g, '<strong><em>$1</em></strong>');
    html = html.replace(/\*\*([^*]+)\*\*\*/g, '<strong>$1</strong>');
    html = html.replace(/__(?![_*])([^_]+)__(?![_*])/g, '<strong>$1</strong>');
    html = html.replace(/(?<!\*)\*([^*\n]+)\*(?!\*)/g, '<em>$1</em>');
    html = html.replace(/(?<!_)_([^_\n]+)_(?!_)/g, '<em>$1</em>');
    html = html.replace(/~~([^~]+)~~/g, '<s>$1</s>');
    codeBlocks.forEach((code, index) => {
      html = html.replace(`__CODE_BLOCK_${index}__`, code);
    });
    html = html.replace(/\n/g, '<br>');
    return html;
  }

  function intToHexColor(n) {
    const v = Number(n);
    if (!Number.isFinite(v)) return '#202225';
    const hex = Math.max(0, Math.min(0xffffff, v)).toString(16).padStart(6, '0');
    return '#' + hex;
  }

  function getExitKind() {
    const el = exitKindEls.find((x) => x && x.checked);
    return el ? el.value : 'tp';
  }

  const currentPriceInput = document.getElementById('pmCurrentPrice');
  const useManualPriceSwitch = document.getElementById('pmUseManualPrice');

  let activeExitSymbol = '';
  let activeExitEntry = '';
  let exitLivePriceInterval = null;
  const EXIT_LIVE_PRICE_INTERVAL_MS = 5000;

  function useManualPrice() {
    return useManualPriceSwitch && useManualPriceSwitch.checked;
  }

  function syncCurrentPriceInputEditable() {
    if (currentPriceInput) {
      currentPriceInput.readOnly = !useManualPrice();
    }
  }

  function clearExitLivePriceInterval() {
    if (exitLivePriceInterval != null) {
      clearInterval(exitLivePriceInterval);
      exitLivePriceInterval = null;
    }
  }

  async function fetchLivePriceForExitModal() {
    if (useManualPrice() || !activeExitPositionId || !currentPriceInput) return;
    try {
      const res = await fetch('/positions/api/live/', { credentials: 'same-origin' });
      const data = res.ok ? await res.json().catch(() => null) : null;
      if (data && Array.isArray(data.positions) && currentPriceInput) {
        const pos = data.positions.find((p) => String(p.id) === String(activeExitPositionId));
        if (pos && pos.mark_str && pos.mark_str !== '-') {
          const price = parseFloat(String(pos.mark_str).replace(/[$,]/g, ''));
          if (!isNaN(price) && price > 0) currentPriceInput.value = price.toFixed(2);
        }
      }
    } catch (_) {}
    renderExitPreview();
  }

  function startExitLivePriceInterval() {
    clearExitLivePriceInterval();
    if (!activeExitPositionId || useManualPrice()) return;
    fetchLivePriceForExitModal();
    exitLivePriceInterval = setInterval(fetchLivePriceForExitModal, EXIT_LIVE_PRICE_INTERVAL_MS);
  }

  function getCurrentPriceOverride() {
    if (!currentPriceInput) return null;
    const raw = String(currentPriceInput.value || '').trim();
    const n = parseFloat(raw);
    return !isNaN(n) && n > 0 ? n : null;
  }

  function formatPriceForPreview(price) {
    if (price == null || isNaN(price) || price <= 0) return 'â€”';
    return '$' + Number(price).toFixed(2);
  }

  function renderManualExitPreview() {
    const symbol = (activeExitSymbol || '').trim().toUpperCase() || 'Trade';
    const entryStr = (activeExitEntry || '').trim();
    const entry = parseFloat(entryStr) || 0;
    const exitRaw = currentPriceInput ? String(currentPriceInput.value || '').trim() : '';
    const exitPrice = parseFloat(exitRaw) || 0;
    const pnlPct = entry > 0 && exitPrice > 0 ? ((exitPrice - entry) / entry * 100).toFixed(1) : 'â€”';
    const exitStr = exitPrice > 0 ? exitPrice.toFixed(2) : 'â€”';
    const color = 0x808080;
    if (previewTitle) previewTitle.innerHTML = parseDiscordMarkdown(symbol + ' Manual Exit');
    if (previewDesc) previewDesc.innerHTML = parseDiscordMarkdown('Manual exit at your chosen price.');
    if (previewFields) {
      previewFields.innerHTML = '';
      const rowDiv = document.createElement('div');
      rowDiv.className = 'discord-embed-fields-row';
      const fields = [
        { name: 'âœ… Entry', value: entry > 0 ? '$' + entry.toFixed(2) : 'â€”' },
        { name: 'ðŸšª Exit', value: exitPrice > 0 ? '$' + exitStr : 'â€”' },
        { name: 'ðŸ’¸ P/L %', value: pnlPct !== 'â€”' ? (parseFloat(pnlPct) >= 0 ? '+' : '') + pnlPct + '%' : 'â€”' },
      ];
      fields.forEach((f) => {
        const div = document.createElement('div');
        div.className = 'discord-embed-field';
        const nameEl = document.createElement('div');
        nameEl.className = 'discord-embed-field-name';
        nameEl.textContent = f.name;
        const valueEl = document.createElement('div');
        valueEl.className = 'discord-embed-field-value';
        valueEl.textContent = f.value;
        div.appendChild(nameEl);
        div.appendChild(valueEl);
        rowDiv.appendChild(div);
      });
      previewFields.appendChild(rowDiv);
    }
    if (previewDescAfter) {
      previewDescAfter.innerHTML = parseDiscordMarkdown('ðŸš¨ Status: Manual exit\n\nDisclaimer: Not financial advice. Trade at your own risk.');
      previewDescAfter.style.display = 'block';
    }
    if (previewFooter) { previewFooter.innerHTML = ''; previewFooter.style.display = 'none'; }
    if (previewColorBar) previewColorBar.style.background = intToHexColor(color);
  }

  function renderExitPreview() {
    if (!activeExitPositionId) return;
    const kind = getExitKind();
    if (kind === 'manual') {
      renderManualExitPreview();
      return;
    }
    const raw = getPreviewText(activeExitPositionId, kind);
    let embed = null;
    try {
      embed = raw ? JSON.parse(raw) : null;
    } catch {
      embed = null;
    }
    const title = embed && embed.title ? String(embed.title) : '';
    const desc = embed && embed.description ? String(embed.description) : '';
    const descAfter = embed && embed.description_after ? String(embed.description_after) : '';
    const color = embed && embed.color != null ? embed.color : null;
    let fields = Array.isArray(embed && embed.fields) ? embed.fields : [];
    const priceOverride = getCurrentPriceOverride();
    if (priceOverride != null && fields.length) {
      var entryFromEmbed = null;
      fields.forEach((f) => {
        const n = (f && f.name != null) ? String(f.name) : '';
        const v = (f && f.value != null) ? String(f.value) : '';
        if (n.indexOf('Entry') !== -1 && (n.indexOf('âœ…') !== -1 || n.indexOf('Entry') !== -1) && /\$?[\d.]+/.test(v)) {
          var num = parseFloat(String(v).replace(/[$,]/g, ''));
          if (!isNaN(num) && num > 0) entryFromEmbed = num;
        }
      });
      fields = fields.map((f) => {
        const name = (f && f.name != null) ? String(f.name) : '';
        let value = (f && f.value != null) ? String(f.value) : '';
        const isPriceField = name.indexOf('Price') !== -1 && name.indexOf('Hit') === -1;
        const isProfitField = name.indexOf('Profit') !== -1 || name.indexOf('P/L') !== -1;
        if (isPriceField && priceOverride != null) {
          value = formatPriceForPreview(priceOverride);
        } else if (isProfitField && entryFromEmbed != null && entryFromEmbed > 0 && priceOverride > 0) {
          var pct = ((priceOverride - entryFromEmbed) / entryFromEmbed * 100).toFixed(1);
          value = (parseFloat(pct) >= 0 ? '+' : '') + pct + '%';
        }
        return Object.assign({}, f, { value });
      });
    }
    const disclaimerText = 'Disclaimer: Not financial advice. Trade at your own risk.';
    const descWithoutDisclaimer = (desc || '').replace(/\n*\s*Disclaimer: Not financial advice\. Trade at your own risk\.\s*$/i, '').trim();
    if (previewTitle) previewTitle.innerHTML = title ? parseDiscordMarkdown(title) : '';
    if (previewDesc) previewDesc.innerHTML = descWithoutDisclaimer ? parseDiscordMarkdown(descWithoutDisclaimer) : '';
    if (previewFields) {
      previewFields.innerHTML = '';
      const perRow = 3;
      for (let r = 0; r < fields.length; r += perRow) {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'discord-embed-fields-row';
        for (let i = r; i < Math.min(r + perRow, fields.length); i++) {
          const f = fields[i];
          const name = (f && f.name != null) ? String(f.name) : '';
          const value = (f && f.value != null) ? String(f.value) : '';
          const div = document.createElement('div');
          div.className = 'discord-embed-field';
          const nameEl = document.createElement('div');
          nameEl.className = 'discord-embed-field-name';
          nameEl.textContent = name;
          const valueEl = document.createElement('div');
          valueEl.className = 'discord-embed-field-value';
          valueEl.textContent = value;
          div.appendChild(nameEl);
          div.appendChild(valueEl);
          rowDiv.appendChild(div);
        }
        previewFields.appendChild(rowDiv);
      }
    }
    if (previewDescAfter) {
      previewDescAfter.innerHTML = descAfter ? parseDiscordMarkdown(descAfter) : '';
      previewDescAfter.style.display = descAfter ? '' : 'none';
    }
    if (previewFooter) {
      previewFooter.innerHTML = parseDiscordMarkdown(disclaimerText);
      previewFooter.style.display = 'block';
    }
    if (previewColorBar) previewColorBar.style.background = intToHexColor(color);
  }

  function openExitModal(id, symbol, entry) {
    activeExitPositionId = id;
    activeExitSymbol = (symbol || '').trim();
    activeExitEntry = (entry || '').trim();
    exitKindEls.forEach((x) => { x.checked = (x.value === 'tp'); });
    if (useManualPriceSwitch) useManualPriceSwitch.checked = false;
    if (currentPriceInput) currentPriceInput.value = '';
    syncCurrentPriceInputEditable();
    clearExitLivePriceInterval();
    // Reset exit parameters
    exitParameters = {
      reduce_percent: '',
      next_level: '',
      next_target_percent: '',
      next_target_value: '',
      raise_sl_to: 'off',
      raise_sl_custom_per: '',
      raise_sl_custom_price: '',
      raise_sl_custom_stock: ''
    };
    // Open modal first, then update current price in background
    if (exitBackdrop) {
      exitBackdrop.style.display = 'flex';
      exitBackdrop.setAttribute('aria-hidden', 'false');
    }
    renderExitPreview();
    startExitLivePriceInterval();
  }

  function closeExitModal() {
    activeExitPositionId = null;
    clearExitLivePriceInterval();
    if (exitBackdrop) {
      exitBackdrop.style.display = 'none';
      exitBackdrop.setAttribute('aria-hidden', 'true');
    }
  }

  function usePartialManualPrice() {
    return partialUseManualPriceSwitch && partialUseManualPriceSwitch.checked;
  }

  function syncPartialCurrentPriceEditable() {
    if (partialCurrentPriceInput) {
      partialCurrentPriceInput.readOnly = !usePartialManualPrice();
    }
  }

  function clearPartialLivePriceInterval() {
    if (partialLivePriceInterval != null) {
      clearInterval(partialLivePriceInterval);
      partialLivePriceInterval = null;
    }
  }

  async function fetchLivePriceForPartialModal() {
    if (usePartialManualPrice() || !activePartialExitPositionId || !partialCurrentPriceInput) return;
    try {
      const res = await fetch('/positions/api/live/', { credentials: 'same-origin' });
      const data = res.ok ? await res.json().catch(() => null) : null;
      if (data && Array.isArray(data.positions) && partialCurrentPriceInput) {
        const pos = data.positions.find((p) => String(p.id) === String(activePartialExitPositionId));
        if (pos && pos.mark_str && pos.mark_str !== '-') {
          const price = parseFloat(String(pos.mark_str).replace(/[$,]/g, ''));
          if (!isNaN(price) && price > 0) partialCurrentPriceInput.value = price.toFixed(2);
        }
      }
    } catch (_) {}
    renderPartialExitPreview();
  }

  function startPartialLivePriceInterval() {
    clearPartialLivePriceInterval();
    if (!activePartialExitPositionId || usePartialManualPrice()) return;
    fetchLivePriceForPartialModal();
    partialLivePriceInterval = setInterval(fetchLivePriceForPartialModal, EXIT_LIVE_PRICE_INTERVAL_MS);
  }

  function getPartialCurrentPriceOverride() {
    if (!partialCurrentPriceInput) return null;
    const raw = String(partialCurrentPriceInput.value || '').trim();
    const n = parseFloat(raw);
    return !isNaN(n) && n > 0 ? n : null;
  }

  function getPartialRiskManagement() {
    return partialRiskManagementEl ? String(partialRiskManagementEl.value || '').trim() : '';
  }

  function renderPartialExitPreview() {
    if (!activePartialExitPositionId) return;
    const raw = getPreviewText(activePartialExitPositionId, 'tp', true);
    let embed = null;
    try {
      embed = raw ? JSON.parse(raw) : null;
    } catch {
      embed = null;
    }
    const title = embed && embed.title ? String(embed.title) : '';
    const desc = embed && embed.description ? String(embed.description) : '';
    const descAfter = embed && embed.description_after ? String(embed.description_after) : '';
    const color = embed && embed.color != null ? embed.color : null;
    const partialDisclaimerText = 'Disclaimer: Not financial advice. Trade at your own risk.';
    const partialDescWithoutDisclaimer = (desc || '').replace(/\n*\s*Disclaimer: Not financial advice\. Trade at your own risk\.\s*$/i, '').trim();
    let fields = Array.isArray(embed && embed.fields) ? embed.fields : [];
    const priceOverride = getPartialCurrentPriceOverride();
    if (priceOverride != null && fields.length) {
      var entryFromEmbed = null;
      fields.forEach((f) => {
        const n = (f && f.name != null) ? String(f.name) : '';
        const v = (f && f.value != null) ? String(f.value) : '';
        if (n.indexOf('Entry') !== -1 && (n.indexOf('âœ…') !== -1 || n.indexOf('Entry') !== -1) && /\$?[\d.]+/.test(v)) {
          var num = parseFloat(String(v).replace(/[$,]/g, ''));
          if (!isNaN(num) && num > 0) entryFromEmbed = num;
        }
      });
      fields = fields.map((f) => {
        const name = (f && f.name != null) ? String(f.name) : '';
        let value = (f && f.value != null) ? String(f.value) : '';
        const isPriceField = name.indexOf('Price') !== -1 && name.indexOf('Hit') === -1;
        const isProfitField = name.indexOf('Profit') !== -1 || name.indexOf('P/L') !== -1;
        if (isPriceField && priceOverride != null) {
          value = formatPriceForPreview(priceOverride);
        } else if (isProfitField && entryFromEmbed != null && entryFromEmbed > 0 && priceOverride > 0) {
          var pct = ((priceOverride - entryFromEmbed) / entryFromEmbed * 100).toFixed(1);
          value = (parseFloat(pct) >= 0 ? '+' : '') + pct + '%';
        }
        return Object.assign({}, f, { value });
      });
    }
    if (partialPreviewTitle) partialPreviewTitle.innerHTML = title ? parseDiscordMarkdown(title) : '';
    if (partialPreviewDesc) partialPreviewDesc.innerHTML = partialDescWithoutDisclaimer ? parseDiscordMarkdown(partialDescWithoutDisclaimer) : '';
    if (partialPreviewFields) {
      partialPreviewFields.innerHTML = '';
      const perRow = 3;
      for (let r = 0; r < fields.length; r += perRow) {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'discord-embed-fields-row';
        for (let i = r; i < Math.min(r + perRow, fields.length); i++) {
          const f = fields[i];
          const name = (f && f.name != null) ? String(f.name) : '';
          const value = (f && f.value != null) ? String(f.value) : '';
          const div = document.createElement('div');
          div.className = 'discord-embed-field';
          const nameEl = document.createElement('div');
          nameEl.className = 'discord-embed-field-name';
          nameEl.textContent = name;
          const valueEl = document.createElement('div');
          valueEl.className = 'discord-embed-field-value';
          valueEl.textContent = value;
          div.appendChild(nameEl);
          div.appendChild(valueEl);
          rowDiv.appendChild(div);
        }
        partialPreviewFields.appendChild(rowDiv);
      }
    }
    if (partialPreviewDescAfter) {
      partialPreviewDescAfter.innerHTML = descAfter ? parseDiscordMarkdown(descAfter) : '';
      partialPreviewDescAfter.style.display = descAfter ? '' : 'none';
    }
    if (partialPreviewFooter) {
      partialPreviewFooter.innerHTML = parseDiscordMarkdown(partialDisclaimerText);
      partialPreviewFooter.style.display = 'block';
    }
    if (partialPreviewColorBar) partialPreviewColorBar.style.background = intToHexColor(color);
  }

  function openPartialExitModal(id, symbol, entry, qty, markStr) {
    activePartialExitPositionId = id;
    activePartialExitEntry = (entry || '').trim();
    if (partialUseManualPriceSwitch) partialUseManualPriceSwitch.checked = false;
    // Set current price from mark if available (so it's not zero when opening)
    if (partialCurrentPriceInput) {
      const mark = String(markStr || '').trim();
      if (mark && mark !== '-') {
        const price = parseFloat(mark.replace(/[$,]/g, ''));
        if (!isNaN(price) && price > 0) {
          partialCurrentPriceInput.value = price.toFixed(2);
        } else {
          partialCurrentPriceInput.value = '';
        }
      } else {
        partialCurrentPriceInput.value = '';
      }
    }
    syncPartialCurrentPriceEditable();
    clearPartialLivePriceInterval();
    // Reset exit parameters
    exitParameters = {
      reduce_percent: '',
      next_level: '',
      next_target_percent: '',
      next_target_value: '',
      raise_sl_to: 'off',
      raise_sl_custom_per: '',
      raise_sl_custom_price: '',
      raise_sl_custom_stock: ''
    };
    // Open modal first, then update current price in background
    if (partialExitBackdrop) {
      partialExitBackdrop.style.display = 'flex';
      partialExitBackdrop.setAttribute('aria-hidden', 'false');
    }
    renderPartialExitPreview();
    startPartialLivePriceInterval();
  }

  function closePartialExitModal() {
    activePartialExitPositionId = null;
    clearPartialLivePriceInterval();
    if (partialExitBackdrop) {
      partialExitBackdrop.style.display = 'none';
      partialExitBackdrop.setAttribute('aria-hidden', 'true');
    }
  }

  async function openExitParameterModal(isPartial, positionId) {
    if (!exitParameterContent) return;
    activeEditParameterPositionId = positionId || null;
    // Ensure activePartialExitPositionId is set when opening Edit Parameters from Partial Exit modal
    if (isPartial && positionId) {
      activePartialExitPositionId = positionId;
    }
    
    if (isPartial && positionId) {
      // Fetch fresh values from backend to get latest saved values
      let rp = '', ntp = '', ntv = '', rsl = 'off', rslCustomPer = '', rslCustomPrice = '', rslCustomStock = '', tpMode = 'percent';
      try {
        const previewRes = await fetch('/positions/' + positionId + '/preview/?partial=1&include_params=1', { credentials: 'same-origin' });
        if (previewRes.ok) {
          const embed = await previewRes.json().catch(() => null);
          if (embed && embed._params) {
            rp = embed._params.reduce_percent || '';
            ntp = embed._params.next_target_percent || '';
            ntv = embed._params.next_target_value || '';
            rsl = embed._params.raise_sl_to || 'off';
            tpMode = embed._params.tp_mode || 'percent';
            rslCustomPer = embed._params.raise_sl_custom_per || '';
            rslCustomPrice = embed._params.raise_sl_custom_price || '';
            rslCustomStock = embed._params.raise_sl_custom_stock || '';
          }
        }
      } catch (e) {
        console.warn('Failed to fetch parameters for Edit Parameters:', e);
      }
      // Fallback to button data attributes if fetch failed or no params returned
      if (!rp && !ntp && !ntv) {
        const btn = document.querySelector(`[data-partial-exit="${positionId}"]`);
        rp = btn ? (btn.getAttribute('data-takeoff-percent') || '') : (exitParameters.reduce_percent || '');
        ntp = btn ? (btn.getAttribute('data-next-target-percent') || '') : (exitParameters.next_target_percent || '');
        ntv = btn ? (btn.getAttribute('data-next-target-value') || '') : (exitParameters.next_target_value || '');
        rsl = btn ? (btn.getAttribute('data-raise-sl-to') || 'off') : (exitParameters.raise_sl_to || 'off');
        rslCustomPer = btn ? (btn.getAttribute('data-raise-sl-custom-per') || '') : (exitParameters.raise_sl_custom_per || '');
        rslCustomPrice = btn ? (btn.getAttribute('data-raise-sl-custom-price') || '') : (exitParameters.raise_sl_custom_price || '');
        rslCustomStock = btn ? (btn.getAttribute('data-raise-sl-custom-stock') || '') : (exitParameters.raise_sl_custom_stock || '');
      }
      // Get entry price from activePartialExitEntry or from button's data attribute
      let entryPrice = parseFloat(activePartialExitEntry || '0') || 0;
      if (!entryPrice || entryPrice <= 0) {
        const btn = document.querySelector(`[data-partial-exit="${positionId}"]`);
        const entryStr = btn ? (btn.getAttribute('data-partial-entry') || '') : '';
        if (entryStr) {
          const parsed = parseFloat(entryStr.replace(/[$,]/g, ''));
          if (!isNaN(parsed) && parsed > 0) entryPrice = parsed;
        }
      }
      exitParameterContent.innerHTML = `
        <form class="pm-param-form" id="pmExitParamForm">
          <div class="pm-param-group">
            <label class="pm-param-label" for="pmReducePercent">Reduce Position Percent (%)</label>
            <div class="pm-param-percent-wrapper">
              <input type="number" id="pmReducePercent" class="pm-param-input" step="0.01" min="0" max="100" placeholder="e.g. 50" value="${rp}" />
              <span class="pm-param-percent-suffix">%</span>
            </div>
          </div>
          <div class="pm-param-group">
            <label class="pm-param-label">Next Target Percent and Price</label>
            <div class="pm-param-row">
              <div class="pm-param-percent-wrapper" style="flex: 1; min-width: 0;">
                <input type="number" id="pmNextTargetPercent" class="pm-param-input" step="0.01" placeholder="Target %" value="${ntp}" title="Next target percent from trade plan" />
                <span class="pm-param-percent-suffix">%</span>
              </div>
              <input type="number" id="pmNextTargetValue" class="pm-param-input" step="0.01" min="0" placeholder="Price ($)" value="${ntv}" title="Next target price" style="flex: 1; min-width: 0;" />
            </div>
          </div>
          <div class="pm-param-group" style="display: none;">
            <label class="pm-param-label" for="pmRaiseSlTo">Raising Stop loss to</label>
            <select id="pmRaiseSlTo" class="pm-param-select">
              <option value="off" ${rsl === 'off' ? 'selected' : ''}>Off</option>
              <option value="entry" ${rsl === 'entry' ? 'selected' : ''}>Break Even</option>
              <option value="custom" ${rsl === 'custom' ? 'selected' : ''}>Custom</option>
            </select>
            <div id="pmRaiseSlCustom" class="pm-param-custom" style="display: ${rsl === 'custom' ? 'block' : 'none'};">
              <label class="pm-param-label">Custom raise</label>
              ${tpMode === 'stock' ? `
                <input type="number" id="pmRaiseSlCustomStock" class="pm-param-input" step="0.01" placeholder="Stock Price ($)" value="${rslCustomStock || ''}" />
              ` : `
                <div class="pm-param-percent-wrapper">
                  <input type="number" id="pmRaiseSlCustomPer" class="pm-param-input" step="0.01" placeholder="Percent (%)" value="${rslCustomPer || ''}" />
                  <span class="pm-param-percent-suffix">%</span>
                </div>
                <input type="number" id="pmRaiseSlCustomPrice" class="pm-param-input" step="0.01" placeholder="Price ($)" value="${rslCustomPrice || ''}" />
              `}
            </div>
          </div>
        </form>
      `;
      
      const raiseSlSelect = document.getElementById('pmRaiseSlTo');
      const customDiv = document.getElementById('pmRaiseSlCustom');
      if (raiseSlSelect && customDiv) {
        raiseSlSelect.addEventListener('change', async () => {
          customDiv.style.display = raiseSlSelect.value === 'custom' ? 'block' : 'none';
          // Save raise_sl_to immediately and update Discord preview when it changes
          const posId = activeEditParameterPositionId || activePartialExitPositionId;
          if (!posId) {
            console.warn('No position ID available for saving raise_sl_to');
            return;
          }
          exitParameters.raise_sl_to = raiseSlSelect.value;
          const raiseSlCustomPerEl = document.getElementById('pmRaiseSlCustomPer');
          const raiseSlCustomPriceEl = document.getElementById('pmRaiseSlCustomPrice');
          const raiseSlCustomStockEl = document.getElementById('pmRaiseSlCustomStock');
          const raiseSlCustomPer = raiseSlCustomPerEl ? String(raiseSlCustomPerEl.value || '').trim() : '';
          const raiseSlCustomPrice = raiseSlCustomPriceEl ? String(raiseSlCustomPriceEl.value || '').trim() : '';
          const raiseSlCustomStock = raiseSlCustomStockEl ? String(raiseSlCustomStockEl.value || '').trim() : '';
          exitParameters.raise_sl_custom_per = raiseSlCustomPer;
          exitParameters.raise_sl_custom_price = raiseSlCustomPrice;
          exitParameters.raise_sl_custom_stock = raiseSlCustomStock;
          
          try {
            const body = {
              update_parameters: true,
              raise_sl_to: raiseSlSelect.value,
            };
            if (raiseSlSelect.value === 'custom') {
              if (raiseSlCustomPer) body.raise_sl_custom_per = raiseSlCustomPer;
              if (raiseSlCustomPrice) body.raise_sl_custom_price = raiseSlCustomPrice;
              if (raiseSlCustomStock) body.raise_sl_custom_stock = raiseSlCustomStock;
            }
            const res = await fetch(`/positions/${posId}/update/`, {
              method: 'POST',
              credentials: 'same-origin',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
              },
              body: JSON.stringify(body),
            });
            const payload = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(payload && payload.error ? payload.error : 'Failed to save raise_sl_to');
            
            // Fetch updated preview - ensure we're using partial exit preview if this is from Partial Exit modal
            var currentPriceParam = '';
            if (partialCurrentPriceInput) {
              const raw = String(partialCurrentPriceInput.value || '').trim();
              const n = parseFloat(raw);
              if (!isNaN(n) && n > 0) currentPriceParam = '&current_price=' + encodeURIComponent(n);
            }
            // Ensure activePartialExitPositionId is set if we're in Partial Exit context
            if (!activePartialExitPositionId && posId) {
              activePartialExitPositionId = posId;
            }
            const previewRes = await fetch('/positions/' + posId + '/preview/?partial=1' + currentPriceParam, { credentials: 'same-origin' });
            if (previewRes.ok) {
              const embed = await previewRes.json().catch(() => null);
              if (embed && typeof embed === 'object') {
                var textarea = document.querySelector('[data-preview-tp-partial-for="' + posId + '"]');
                if (textarea) {
                  textarea.value = JSON.stringify(embed);
                  renderPartialExitPreview();
                } else {
                  console.warn('Could not find preview textarea for position', posId);
                }
              }
            } else {
              console.warn('Failed to fetch preview after raise_sl_to change');
            }
          } catch (e) {
            console.error('Failed to save/update preview after raise_sl_to change:', e);
          }
        });
      }
      
      // Auto-calculation between Next Target Percent and Price, and save/update preview
      const nextTargetPercentEl = document.getElementById('pmNextTargetPercent');
      const nextTargetValueEl = document.getElementById('pmNextTargetValue');
      if (nextTargetPercentEl && nextTargetValueEl && entryPrice > 0) {
        let updatingFromPercent = false;
        let updatingFromPrice = false;
        let saveTimeout = null;
        
        const saveNextTargetAndUpdatePreview = async () => {
          if (!activeEditParameterPositionId || !activePartialExitPositionId) return;
          const nextTargetPercent = String(nextTargetPercentEl.value || '').trim();
          const nextTargetValue = String(nextTargetValueEl.value || '').trim();
          exitParameters.next_target_percent = nextTargetPercent;
          exitParameters.next_target_value = nextTargetValue;
          
          try {
            const body = {
              update_parameters: true,
            };
            if (nextTargetPercent) body.next_target_percent = nextTargetPercent;
            if (nextTargetValue) body.next_target_value = nextTargetValue;
            const res = await fetch(`/positions/${activeEditParameterPositionId}/update/`, {
              method: 'POST',
              credentials: 'same-origin',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
              },
              body: JSON.stringify(body),
            });
            if (!res.ok) throw new Error('Failed to save next target');
            
            var currentPriceParam = '';
            if (partialCurrentPriceInput) {
              const raw = String(partialCurrentPriceInput.value || '').trim();
              const n = parseFloat(raw);
              if (!isNaN(n) && n > 0) currentPriceParam = '&current_price=' + encodeURIComponent(n);
            }
            const previewRes = await fetch('/positions/' + activePartialExitPositionId + '/preview/?partial=1' + currentPriceParam, { credentials: 'same-origin' });
            if (previewRes.ok) {
              const embed = await previewRes.json().catch(() => null);
              if (embed && typeof embed === 'object') {
                var textarea = document.querySelector('[data-preview-tp-partial-for="' + activePartialExitPositionId + '"]');
                if (textarea) textarea.value = JSON.stringify(embed);
                renderPartialExitPreview();
              }
            }
          } catch (e) {
            console.warn('Failed to save/update preview after next target change:', e);
          }
        };
        
        nextTargetPercentEl.addEventListener('input', () => {
          if (updatingFromPrice) return;
          const percent = parseFloat(nextTargetPercentEl.value);
          if (!isNaN(percent) && percent !== 0 && entryPrice > 0) {
            updatingFromPercent = true;
            const price = entryPrice * (1 + percent / 100);
            nextTargetValueEl.value = price.toFixed(2);
            updatingFromPercent = false;
          }
          // Debounce save/update preview
          if (saveTimeout) clearTimeout(saveTimeout);
          saveTimeout = setTimeout(saveNextTargetAndUpdatePreview, 500);
        });
        
        nextTargetValueEl.addEventListener('input', () => {
          if (updatingFromPercent) return;
          const price = parseFloat(nextTargetValueEl.value);
          if (!isNaN(price) && price > 0 && entryPrice > 0) {
            updatingFromPrice = true;
            const percent = ((price - entryPrice) / entryPrice) * 100;
            nextTargetPercentEl.value = percent.toFixed(2);
            updatingFromPrice = false;
          }
          // Debounce save/update preview
          if (saveTimeout) clearTimeout(saveTimeout);
          saveTimeout = setTimeout(saveNextTargetAndUpdatePreview, 500);
        });
      }
    } else {
      // Full Exit parameters (can be empty for now or add fields later)
      exitParameterContent.innerHTML = `
        <div class="pm-modal-row">
          <p style="color: rgba(232, 236, 255, 0.65);">No additional parameters for Full Exit.</p>
        </div>
      `;
    }
    
    if (exitParameterBackdrop) {
      exitParameterBackdrop.style.display = 'flex';
      exitParameterBackdrop.setAttribute('aria-hidden', 'false');
    }
  }

  function closeExitParameterModal() {
    if (exitParameterBackdrop) {
      exitParameterBackdrop.style.display = 'none';
      exitParameterBackdrop.setAttribute('aria-hidden', 'true');
    }
  }

  async function saveExitParameters(isPartial) {
    if (isPartial) {
      const reducePercentEl = document.getElementById('pmReducePercent');
      const nextTargetPercentEl = document.getElementById('pmNextTargetPercent');
      const nextTargetValueEl = document.getElementById('pmNextTargetValue');
      const raiseSlToEl = document.getElementById('pmRaiseSlTo');
      const raiseSlCustomPerEl = document.getElementById('pmRaiseSlCustomPer');
      const raiseSlCustomPriceEl = document.getElementById('pmRaiseSlCustomPrice');
      const raiseSlCustomStockEl = document.getElementById('pmRaiseSlCustomStock');
      
      const reducePercent = reducePercentEl ? String(reducePercentEl.value || '').trim() : '';
      const nextTargetPercent = nextTargetPercentEl ? String(nextTargetPercentEl.value || '').trim() : '';
      const nextTargetValue = nextTargetValueEl ? String(nextTargetValueEl.value || '').trim() : '';
      const raiseSlTo = raiseSlToEl ? String(raiseSlToEl.value || 'off').trim() : 'off';
      const raiseSlCustomPer = raiseSlCustomPerEl ? String(raiseSlCustomPerEl.value || '').trim() : '';
      const raiseSlCustomPrice = raiseSlCustomPriceEl ? String(raiseSlCustomPriceEl.value || '').trim() : '';
      const raiseSlCustomStock = raiseSlCustomStockEl ? String(raiseSlCustomStockEl.value || '').trim() : '';
      
      exitParameters.reduce_percent = reducePercent;
      exitParameters.next_target_percent = nextTargetPercent;
      exitParameters.next_target_value = nextTargetValue;
      exitParameters.raise_sl_to = raiseSlTo;
      exitParameters.raise_sl_custom_per = raiseSlCustomPer;
      exitParameters.raise_sl_custom_price = raiseSlCustomPrice;
      exitParameters.raise_sl_custom_stock = raiseSlCustomStock;
      
      if (activeEditParameterPositionId) {
        try {
          const body = {
            update_parameters: true,
            reduce_percent: reducePercent,
            next_target_percent: nextTargetPercent,
            next_target_value: nextTargetValue,
            raise_sl_to: raiseSlTo,
          };
          if (raiseSlTo === 'custom') {
            if (raiseSlCustomPer) body.raise_sl_custom_per = raiseSlCustomPer;
            if (raiseSlCustomPrice) body.raise_sl_custom_price = raiseSlCustomPrice;
            if (raiseSlCustomStock) body.raise_sl_custom_stock = raiseSlCustomStock;
          }
          const res = await fetch(`/positions/${activeEditParameterPositionId}/update/`, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify(body),
          });
          const payload = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(payload && payload.error ? payload.error : 'Failed to save parameters');
          
          var currentPriceParam = '';
          if (partialCurrentPriceInput) {
            const raw = String(partialCurrentPriceInput.value || '').trim();
            const n = parseFloat(raw);
            if (!isNaN(n) && n > 0) currentPriceParam = '&current_price=' + encodeURIComponent(n);
          }
          const previewRes = await fetch('/positions/' + activeEditParameterPositionId + '/preview/?partial=1' + currentPriceParam, { credentials: 'same-origin' });
          if (previewRes.ok) {
            const embed = await previewRes.json().catch(() => null);
            if (embed && typeof embed === 'object') {
              var textarea = document.querySelector('[data-preview-tp-partial-for="' + activeEditParameterPositionId + '"]');
              if (textarea) textarea.value = JSON.stringify(embed);
              // Update button data attributes with saved values so reopening modal shows them
              const btn = document.querySelector('[data-partial-exit="' + activeEditParameterPositionId + '"]');
              if (btn) {
                if (reducePercent) btn.setAttribute('data-takeoff-percent', reducePercent);
                if (nextTargetPercent) btn.setAttribute('data-next-target-percent', nextTargetPercent);
                if (nextTargetValue) btn.setAttribute('data-next-target-value', nextTargetValue);
                if (raiseSlTo) btn.setAttribute('data-raise-sl-to', raiseSlTo);
                if (raiseSlTo === 'custom') {
                  if (raiseSlCustomPer) btn.setAttribute('data-raise-sl-custom-per', raiseSlCustomPer);
                  if (raiseSlCustomPrice) btn.setAttribute('data-raise-sl-custom-price', raiseSlCustomPrice);
                  if (raiseSlCustomStock) btn.setAttribute('data-raise-sl-custom-stock', raiseSlCustomStock);
                }
              }
            }
          }
        } catch (e) {
          console.warn('Save exit parameters failed:', e);
          alert(String(e && e.message ? e.message : 'Failed to save parameters'));
          return;
        }
      }
    }
    closeExitParameterModal();
    if (isPartial && activePartialExitPositionId) {
      renderPartialExitPreview();
    } else if (!isPartial && activeExitPositionId) {
      renderExitPreview();
    }
  }

  async function postPartialExitUpdate(id, currentPrice) {
    // Always set partial_exit to true for partial exit
    const body = { kind: 'tp', partial_exit: true };
    if (currentPrice != null && currentPrice > 0) body.current_price = currentPrice;
    
    // Get latest exit parameters from button data attributes (most up-to-date) or exitParameters state
    const btn = document.querySelector(`[data-partial-exit="${id}"]`);
    const reducePercent = btn ? (btn.getAttribute('data-takeoff-percent') || '') : (exitParameters.reduce_percent || '');
    const nextTargetPercent = btn ? (btn.getAttribute('data-next-target-percent') || '') : (exitParameters.next_target_percent || '');
    const nextTargetValue = btn ? (btn.getAttribute('data-next-target-value') || '') : (exitParameters.next_target_value || '');
    const raiseSlTo = btn ? (btn.getAttribute('data-raise-sl-to') || 'off') : (exitParameters.raise_sl_to || 'off');
    const raiseSlCustomPer = btn ? (btn.getAttribute('data-raise-sl-custom-per') || '') : (exitParameters.raise_sl_custom_per || '');
    const raiseSlCustomPrice = btn ? (btn.getAttribute('data-raise-sl-custom-price') || '') : (exitParameters.raise_sl_custom_price || '');
    const raiseSlCustomStock = btn ? (btn.getAttribute('data-raise-sl-custom-stock') || '') : (exitParameters.raise_sl_custom_stock || '');
    
    // Add exit parameters to body
    if (reducePercent) body.reduce_percent = reducePercent;
    if (nextTargetPercent) body.next_target_percent = nextTargetPercent;
    if (nextTargetValue) body.next_target_value = nextTargetValue;
    if (raiseSlTo && raiseSlTo !== 'off') {
      body.raise_sl_to = raiseSlTo;
      if (raiseSlTo === 'custom') {
        if (raiseSlCustomPer) body.raise_sl_custom_per = raiseSlCustomPer;
        if (raiseSlCustomPrice) body.raise_sl_custom_price = raiseSlCustomPrice;
        if (raiseSlCustomStock) body.raise_sl_custom_stock = raiseSlCustomStock;
      }
    }
    
    // Ensure partial_exit is always true for partial exit
    body.partial_exit = true;
    
    const res = await fetch(`/positions/${id}/update/`, {
      method: 'POST',
      credentials: 'same-origin',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken'),
      },
      body: JSON.stringify(body),
    });
    const payload = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(payload && payload.error ? payload.error : 'Failed to post update');
    window.location.reload();
  }

  async function postExitUpdate(id, kind, currentPrice) {
    const body = { kind: kind, partial_exit: false };
    if (currentPrice != null && currentPrice > 0) body.current_price = currentPrice;
    const res = await fetch(`/positions/${id}/update/`, {
      method: 'POST',
      credentials: 'same-origin',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken'),
      },
      body: JSON.stringify(body),
    });
    const payload = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(payload && payload.error ? payload.error : 'Failed to post update');
    window.location.reload();
  }

  document.querySelectorAll('[data-partial-exit]').forEach((btn) => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-partial-exit');
      if (!id) return;
      const symbol = btn.getAttribute('data-partial-symbol') || '';
      const entry = btn.getAttribute('data-partial-entry') || '';
      const qty = btn.getAttribute('data-partial-qty') || '';
      // Use live-updated mark from row if available, else fallback to data attribute
      let mark = '';
      const row = btn.closest('tr');
      if (row) {
        const markCell = row.querySelector('td.pm-live-mark');
        if (markCell && markCell.textContent && markCell.textContent.trim() !== '-') {
          mark = markCell.textContent.trim().replace(/^\$/, '');
        }
      }
      if (!mark) mark = btn.getAttribute('data-partial-mark') || '';
      openPartialExitModal(id, symbol, entry, qty, mark);
    });
  });

  document.querySelectorAll('[data-post-exit]').forEach((btn) => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-post-exit');
      if (!id) return;
      const symbol = btn.getAttribute('data-exit-symbol') || '';
      const entry = btn.getAttribute('data-exit-entry') || '';
      openExitModal(id, symbol, entry);
    });
  });

  if (currentPriceInput) {
    currentPriceInput.addEventListener('input', renderExitPreview);
    currentPriceInput.addEventListener('change', renderExitPreview);
  }
  if (useManualPriceSwitch) {
    useManualPriceSwitch.addEventListener('change', () => {
      syncCurrentPriceInputEditable();
      if (useManualPrice()) {
        clearExitLivePriceInterval();
      } else {
        startExitLivePriceInterval();
      }
    });
  }

  exitKindEls.forEach((el) => el.addEventListener('change', renderExitPreview));

  document.querySelectorAll('[data-exit-close], [data-exit-cancel]').forEach((btn) => {
    btn.addEventListener('click', closeExitModal);
  });

  if (exitBackdrop) {
    exitBackdrop.addEventListener('click', (e) => {
      if (e.target === exitBackdrop) closeExitModal();
    });
  }

  if (partialCurrentPriceInput) {
    partialCurrentPriceInput.addEventListener('input', renderPartialExitPreview);
    partialCurrentPriceInput.addEventListener('change', renderPartialExitPreview);
  }
  if (partialUseManualPriceSwitch) {
    partialUseManualPriceSwitch.addEventListener('change', () => {
      syncPartialCurrentPriceEditable();
      if (usePartialManualPrice()) {
        clearPartialLivePriceInterval();
      } else {
        startPartialLivePriceInterval();
      }
    });
  }
  document.querySelectorAll('[data-partial-exit-close], [data-partial-exit-cancel]').forEach((btn) => {
    btn.addEventListener('click', closePartialExitModal);
  });

  if (partialExitBackdrop) {
    partialExitBackdrop.addEventListener('click', (e) => {
      if (e.target === partialExitBackdrop) closePartialExitModal();
    });
  }

  // Exit Parameter modal event listeners
  if (exitParameterBtn) {
    exitParameterBtn.addEventListener('click', () => openExitParameterModal(false, activeExitPositionId));
  }
  if (partialExitParameterBtn) {
    partialExitParameterBtn.addEventListener('click', () => openExitParameterModal(true, activePartialExitPositionId));
  }
  if (exitParameterSaveBtn) {
    exitParameterSaveBtn.addEventListener('click', () => {
      const isPartial = activePartialExitPositionId !== null;
      saveExitParameters(isPartial);
    });
  }
  document.querySelectorAll('[data-exit-parameter-close], [data-exit-parameter-cancel]').forEach((btn) => {
    btn.addEventListener('click', closeExitParameterModal);
  });
  if (exitParameterBackdrop) {
    exitParameterBackdrop.addEventListener('click', (e) => {
      if (e.target === exitParameterBackdrop) closeExitParameterModal();
    });
  }

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (exitParameterBackdrop && exitParameterBackdrop.style.display === 'flex') closeExitParameterModal();
      else if (partialExitBackdrop && partialExitBackdrop.style.display === 'flex') closePartialExitModal();
      else closeExitModal();
    }
  });

  if (partialExitConfirmBtn) {
    partialExitConfirmBtn.addEventListener('click', async () => {
      if (!activePartialExitPositionId) return;
      const currentPrice = getPartialCurrentPriceOverride();
      partialExitConfirmBtn.disabled = true;
      try {
        await postPartialExitUpdate(activePartialExitPositionId, currentPrice);
      } catch (e) {
        console.warn('Partial exit failed:', e);
        partialExitConfirmBtn.disabled = false;
        alert(String(e && e.message ? e.message : 'Failed'));
      }
    });
  }

  if (exitConfirmBtn) {
    exitConfirmBtn.addEventListener('click', async () => {
      if (!activeExitPositionId) return;
      const kind = getExitKind();
      const currentPrice = getCurrentPriceOverride();
      exitConfirmBtn.disabled = true;
      try {
        await postExitUpdate(activeExitPositionId, kind, currentPrice);
      } catch (e) {
        console.warn('Post update failed:', e);
        exitConfirmBtn.disabled = false;
        alert(String(e && e.message ? e.message : 'Failed'));
      }
    });
  }

  async function setMode(id, mode) {
    const res = await fetch(`/positions/${id}/mode/`, {
      method: 'POST',
      credentials: 'same-origin',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken'),
      },
      body: JSON.stringify({ mode: mode }),
    });
    const payload = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(payload && payload.error ? payload.error : 'Failed to set mode');
    window.location.reload();
  }

  document.querySelectorAll('[data-mode]').forEach((btn) => {
    btn.addEventListener('click', async () => {
      const id = btn.getAttribute('data-mode');
      const modeTo = btn.getAttribute('data-mode-to');
      if (!id || !modeTo) return;
      btn.disabled = true;
      try {
        await setMode(id, modeTo);
      } catch (e) {
        console.warn('Set mode failed:', e);
        btn.disabled = false;
        alert(String(e && e.message ? e.message : 'Failed'));
      }
    });
  });

  // Real-time update of current price (Mark) and P/L for open positions (reduced frequency to limit API calls)
  const LIVE_POLL_INTERVAL_MS = 15000;
  function updateLivePositions() {
    const openTab = document.getElementById('tab-open');
    if (!openTab || openTab.style.display === 'none') return;
    const rows = document.querySelectorAll('#tab-open tr[data-position-id]');
    if (!rows.length) return;
    fetch('/positions/api/live/', { credentials: 'same-origin' })
      .then((res) => {
        if (!res.ok) {
          console.warn('Position live update failed:', res.status, res.statusText);
          return null;
        }
        return res.json();
      })
      .then((data) => {
        if (!data || !Array.isArray(data.positions)) {
          if (data) console.warn('Position live update: invalid response format', data);
          return;
        }
        const byId = {};
        data.positions.forEach((p) => { byId[String(p.id)] = p; });
        let updatedCount = 0;
        rows.forEach((row) => {
          const id = row.getAttribute('data-position-id');
          const pos = id ? byId[id] : null;
          if (!pos) return;
          const markCell = row.querySelector('td.pm-live-mark');
          if (markCell) {
            const newMark = pos.mark_str === '-' ? '-' : '$' + pos.mark_str;
            if (markCell.textContent !== newMark) {
              markCell.textContent = newMark;
              updatedCount++;
            }
          }
          const pnlSpan = row.querySelector('span.pm-live-pnl');
          if (pnlSpan) {
            pnlSpan.textContent = pos.pnl_pct_str;
            pnlSpan.className = 'pm-pill pm-live-pnl ' + (pos.status_kind || '');
          }
          const realizedSpan = row.querySelector('span.pm-live-realized-pnl');
          if (realizedSpan) {
            realizedSpan.textContent = pos.realized_pnl_pct_str;
            realizedSpan.className = 'pm-pill pm-live-realized-pnl ' + (pos.realized_kind || '');
          }
        });
        if (updatedCount > 0) {
          console.debug('Position live update: updated', updatedCount, 'mark prices');
        }
      })
      .catch((err) => {
        console.warn('Position live update error:', err);
      });
  }
  updateLivePositions();
  setInterval(updateLivePositions, LIVE_POLL_INTERVAL_MS);
})();
</script>
{% endblock %}

