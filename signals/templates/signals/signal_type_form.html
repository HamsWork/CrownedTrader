{% extends 'signals/base.html' %}
{% load static %}

{% block title %}{% if form_type == 'create' %}Create Signal Type{% else %}Edit Signal Type{% endif %} - Crowned Trader Dashboard{% endblock %}

{% block breadcrumbs %}
<a href="{% url 'signal_types_list' %}">Signal Types</a>
<span>/</span>
<span>{% if form_type == 'create' %}Create New Type{% else %}{% if is_locked %}View Template{% else %}Edit Template{% endif %}{% endif %}</span>
{% endblock %}

{% block extra_css %}
<style>
    .form-container {
        max-width: 1000px;
        margin: 0 auto;
        position: relative;
    }

    .form-wrapper {
        display: flex;
        gap: 30px;
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 20px;
        align-items: flex-start;
    }

    .form-content {
        flex: 1;
        max-width: 1000px;
    }

    .form-header {
        margin-bottom: 30px;
        text-align: center;
    }

    .form-header h2 {
        color: #333;
        font-size: 2em;
        margin: 0;
    }

    .form-section {
        background: #f8f9fa;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
    }

    .form-section-title {
        color: #333;
        font-size: 1.3em;
        font-weight: 600;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #ddd;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 600;
    }

    .form-input, .form-textarea, .form-select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1em;
        font-family: inherit;
        transition: border-color 0.3s;
    }

    .form-input:focus, .form-textarea:focus, .form-select:focus {
        outline: none;
        border-color: #667eea;
    }

    /* Read-only input styles */
    .form-input[readonly],
    .form-textarea[readonly],
    input[readonly].form-input,
    textarea[readonly].form-textarea,
    .form-input.readonly,
    .form-textarea.readonly,
    .form-select[disabled],
    .form-select.readonly,
    select[disabled].form-select {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
        border: 2px solid #dee2e6 !important;
        color: #495057 !important;
        cursor: not-allowed !important;
        opacity: 0.85;
        position: relative;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .form-input[readonly]:hover,
    .form-textarea[readonly]:hover,
    input[readonly].form-input:hover,
    textarea[readonly].form-textarea:hover,
    .form-input.readonly:hover,
    .form-textarea.readonly:hover,
    .form-select[disabled]:hover,
    .form-select.readonly:hover {
        border-color: #adb5bd !important;
        opacity: 0.9;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.08);
    }

    /* Read-only indicator */
    .readonly-indicator {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        opacity: 0.4;
        pointer-events: none;
        font-size: 0.9em;
    }

    /* Inline lock badge (placed next to labels like the screenshot) */
    .lock-inline {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 18px;
        height: 18px;
        margin-left: 8px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(42, 55, 95, 0.55);
        color: rgba(232, 236, 255, 0.70);
        transform: translateY(2px);
    }

    .lock-inline svg {
        width: 12px;
        height: 12px;
        display: block;
    }

    .form-group {
        position: relative;
    }

    .dynamic-item .form-group {
        position: relative;
    }

    .form-textarea {
        resize: vertical;
        min-height: 80px;
    }

    .form-group small {
        display: block;
        margin-top: 5px;
        color: #666;
        font-size: 0.9em;
    }

    .color-input-group {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .color-input-group input[type="color"] {
        width: 60px;
        height: 50px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        cursor: pointer;
    }

    .color-input-group input[type="text"] {
        flex: 1;
    }

    .dynamic-list {
        margin-top: 15px;
    }

    .dynamic-item {
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        position: relative;
    }

    .dynamic-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .dynamic-item-title {
        font-weight: 600;
        color: #333;
        font-size: 1.1em;
    }

    .btn-remove {
        background: #dc3545;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 600;
    }

    .btn-remove:hover {
        background: #c82333;
    }

    .btn-add {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1em;
        font-weight: 600;
        margin-top: 10px;
    }

    .btn-add:hover {
        background: #218838;
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
    }

    .form-row.full-width {
        grid-template-columns: 1fr;
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .checkbox-group input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }

    .checkbox-group label {
        margin: 0;
        cursor: pointer;
        font-weight: normal;
    }

    .form-actions {
        display: flex;
        gap: 15px;
        margin-top: 30px;
        justify-content: center;
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 1em;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background: #5a6268;
    }

    .error-message {
        color: #dc3545;
        font-size: 0.9em;
        margin-top: 5px;
    }

    .help-text {
        background: #e7f3ff;
        border-left: 4px solid #667eea;
        padding: 12px;
        border-radius: 4px;
        margin-top: 10px;
        font-size: 0.9em;
        color: #004085;
    }

    .help-text code {
        background: rgba(0, 0, 0, 0.05);
        padding: 2px 6px;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
    }

    /* Discord Preview Styles */
    .discord-preview-wrapper {
        position: sticky;
        top: 20px;
        width: 380px;
        flex-shrink: 0;
        z-index: 10;
    }

    .discord-preview-container {
        background: #2f3136;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        position: sticky;
        top: 20px;
    }

    .discord-preview {
        max-width: 100%;
        margin: 0 auto;
    }

    .preview-header {
        color: #dcddde;
        font-size: 0.9em;
        margin-bottom: 15px;
        text-align: center;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .discord-embed {
        display: flex;
        background: #2f3136;
        border-radius: 4px;
        overflow: hidden;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    .discord-embed-color-bar {
        width: 4px;
        background: #5865f2;
        flex-shrink: 0;
    }

    .discord-embed-content {
        flex: 1;
        padding: 12px 16px 12px 12px;
        color: #dcddde;
        font-size: 14px;
        line-height: 1.375;
    }

    .discord-embed-title {
        color: #ffffff;
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 8px;
        min-height: 20px;
    }

    .discord-embed-title:empty {
        display: none;
    }

    /* Discord Markdown Styles */
    .discord-embed-title strong,
    .discord-embed-description strong,
    .discord-embed-field-name strong,
    .discord-embed-field-value strong,
    .discord-embed-footer strong {
        font-weight: 600;
    }

    .discord-embed-title em,
    .discord-embed-description em,
    .discord-embed-field-name em,
    .discord-embed-field-value em,
    .discord-embed-footer em {
        font-style: italic;
    }

    .discord-embed-title u,
    .discord-embed-description u,
    .discord-embed-field-name u,
    .discord-embed-field-value u,
    .discord-embed-footer u {
        text-decoration: underline;
    }

    .discord-embed-title s,
    .discord-embed-description s,
    .discord-embed-field-name s,
    .discord-embed-field-value s,
    .discord-embed-footer s {
        text-decoration: line-through;
    }

    .discord-embed-title code,
    .discord-embed-description code,
    .discord-embed-field-name code,
    .discord-embed-field-value code,
    .discord-embed-footer code {
        background: rgba(0, 0, 0, 0.3);
        padding: 2px 4px;
        border-radius: 3px;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 0.9em;
    }

    .discord-embed-title pre,
    .discord-embed-description pre,
    .discord-embed-field-name pre,
    .discord-embed-field-value pre,
    .discord-embed-footer pre {
        background: rgba(0, 0, 0, 0.3);
        padding: 8px;
        border-radius: 4px;
        margin: 4px 0;
        overflow-x: auto;
    }

    .discord-embed-title pre code,
    .discord-embed-description pre code,
    .discord-embed-field-name pre code,
    .discord-embed-field-value pre code,
    .discord-embed-footer pre code {
        background: none;
        padding: 0;
    }

    .discord-embed-description {
        color: #dcddde;
        margin-bottom: 8px;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .discord-embed-description:empty {
        display: none;
    }

    .discord-embed-fields {
        margin-top: 8px;
    }

    .discord-embed-field {
        margin-bottom: 8px;
    }

    .discord-embed-field-inline {
        flex: 0 0 calc(33.333% - 11px);
        max-width: calc(33.333% - 11px);
    }

    .discord-embed-field-name {
        color: #ffffff;
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 2px;
        min-height: 16px;
    }

    .discord-embed-field-name:empty {
        display: none;
    }

    .discord-embed-field-value {
        color: #dcddde;
        font-size: 14px;
        white-space: pre-wrap;
        word-wrap: break-word;
        min-height: 16px;
    }

    .discord-embed-field-value:empty {
        display: none;
    }

    .discord-embed-footer {
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid rgba(255, 255, 255, 0.06);
        color: #72767d;
        font-size: 12px;
        min-height: 14px;
    }

    .discord-embed-footer:empty {
        display: none;
    }

    /* Responsive design for preview */
    @media (max-width: 1200px) {
        .form-wrapper {
            flex-direction: column;
        }

        .discord-preview-wrapper {
            width: 100%;
            position: relative;
            top: 0;
            margin-top: 30px;
        }

        .discord-preview-container {
            position: relative;
            top: 0;
            max-width: 520px;
            margin: 0 auto;
        }
    }

    @media (max-width: 768px) {
        .form-wrapper {
            padding: 0 10px;
        }

        .discord-preview-container {
            padding: 15px;
        }
    }

    /* ===== Crowned Trader Dark Theme Overrides (match Submit Signal page) ===== */
    .stf-page {
        width: 100%;
        max-width: 1840px;
        margin: 0 auto;
    }

    .form-wrapper {
        display: grid !important;
        grid-template-columns: minmax(0, 1fr) clamp(420px, 34vw, 560px) !important;
        gap: 30px !important;
        max-width: none !important;
        padding: 0 !important;
        align-items: start !important;
    }

    .form-content {
        max-width: none !important;
        min-width: 0;
    }

    .form-container {
        max-width: none !important;
        margin: 0 !important;
    }

    .form-header {
        text-align: left !important;
        margin-bottom: 18px !important;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 16px;
        margin-bottom: 22px;
        position: sticky;
        top: 76px; /* below 60px top header + spacing */
        z-index: 30;
        padding: 14px 0;
        background: linear-gradient(180deg, rgba(2, 6, 23, 0.92), rgba(2, 6, 23, 0.55), rgba(2, 6, 23, 0));
        backdrop-filter: blur(8px);
    }

    .page-title h1 {
        margin: 0 0 8px 0;
        color: #e8ecff;
        font-size: 2.2em;
        font-weight: 800;
    }

    .page-title p {
        margin: 0;
        color: rgba(232, 236, 255, 0.65);
        font-size: 1.05em;
    }

    .page-actions {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .btn-cancel {
        background: rgba(255, 255, 255, 0.06);
        color: rgba(232, 236, 255, 0.92);
        padding: 12px 18px;
        border: 1px solid rgba(42, 55, 95, 0.55);
        border-radius: 12px;
        text-decoration: none;
        font-weight: 700;
        cursor: pointer;
        transition: background 160ms ease, border-color 160ms ease, transform 160ms ease;
        height: 44px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        white-space: nowrap;
    }

    .btn-cancel:hover {
        background: rgba(255, 255, 255, 0.09);
        border-color: rgba(42, 55, 95, 0.85);
        transform: translateY(-1px);
    }

    .btn-save {
        background: var(--accent);
        color: #0b1020;
        padding: 12px 18px;
        border: none;
        border-radius: 12px;
        font-weight: 800;
        cursor: pointer;
        transition: transform 160ms ease, box-shadow 160ms ease, background 160ms ease;
        height: 44px;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        white-space: nowrap;
        box-shadow: 0 10px 26px rgba(var(--accent-rgb), 0.18);
    }

    .btn-save:hover {
        transform: translateY(-1px);
        background: color-mix(in srgb, var(--accent) 85%, #ffffff 15%);
        box-shadow: 0 14px 30px rgba(var(--accent-rgb), 0.22);
    }

    .btn-save[disabled] {
        opacity: 0.55;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .form-section {
        background: rgba(15, 23, 42, 0.72) !important;
        border: 1px solid rgba(42, 55, 95, 0.55) !important;
        border-radius: 16px !important;
        padding: 22px !important;
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 0;
    }

    .section-icon {
        width: 32px;
        height: 32px;
        border-radius: 10px;
        display: grid;
        place-items: center;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(42, 55, 95, 0.55);
        color: var(--accent);
        flex: 0 0 auto;
    }

    .section-icon svg {
        width: 18px;
        height: 18px;
        display: block;
    }

    .section-divider {
        height: 1px;
        width: 100%;
        background: rgba(255, 255, 255, 0.08);
        margin: 14px 0 18px 0;
    }

    .form-section-title {
        margin: 0 !important;
        color: #e8ecff !important;
        font-size: 1.15em !important;
        font-weight: 800 !important;
        padding-bottom: 0 !important;
        border-bottom: none !important;
    }

    .form-group label {
        color: #e8ecff !important;
    }

    .form-input, .form-textarea, .form-select {
        border: 1px solid rgba(42, 55, 95, 0.65) !important;
        border-radius: 12px !important;
        background: rgba(10, 16, 35, 0.72) !important;
        color: #e8ecff !important;
    }

    .form-input:focus, .form-textarea:focus, .form-select:focus {
        border-color: var(--accent) !important;
        box-shadow: 0 0 0 3px rgba(var(--accent-rgb), 0.10) !important;
    }

    .dynamic-item {
        background: linear-gradient(180deg, rgba(10, 16, 35, 0.62), rgba(10, 16, 35, 0.40)) !important;
        border: 1px solid rgba(42, 55, 95, 0.65) !important;
        border-radius: 18px !important;
        padding: 18px !important;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
    }

    .dynamic-item-header {
        margin-bottom: 18px !important;
    }

    .dynamic-item-title {
        color: #e8ecff !important;
        font-weight: 800 !important;
    }

    .btn-add {
        background: rgba(255, 255, 255, 0.06) !important;
        border: 1px solid rgba(42, 55, 95, 0.55) !important;
        color: #e8ecff !important;
    }

    .btn-add:hover {
        background: rgba(255, 255, 255, 0.09) !important;
        border-color: rgba(42, 55, 95, 0.85) !important;
    }

    /* Wide dashed "Add" CTA buttons (match screenshot) */
    .btn-add-wide {
        width: 100%;
        height: 46px;
        border-radius: 14px;
        border: 1px dashed rgba(42, 55, 95, 0.75);
        background: rgba(10, 16, 35, 0.35);
        color: rgba(232, 236, 255, 0.80);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        font-weight: 800;
        cursor: pointer;
        transition: background 160ms ease, border-color 160ms ease, transform 160ms ease;
    }

    .btn-add-wide .plus {
        width: 22px;
        height: 22px;
        border-radius: 8px;
        display: grid;
        place-items: center;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(42, 55, 95, 0.55);
        color: rgba(232, 236, 255, 0.78);
        font-size: 16px;
        line-height: 1;
        transform: translateY(-1px);
    }

    .btn-add-wide:hover {
        background: rgba(255, 255, 255, 0.06);
        border-color: rgba(42, 55, 95, 0.95);
        transform: translateY(-1px);
    }

    .btn-add-wide.secondary {
        color: rgba(232, 236, 255, 0.70);
        border-color: rgba(42, 55, 95, 0.55);
        background: rgba(10, 16, 35, 0.25);
    }

    .add-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 12px;
    }

    @media (max-width: 640px) {
        .add-actions {
            grid-template-columns: 1fr;
        }
    }

    .btn-remove {
        background: transparent !important;
        border: none !important;
        color: #ff4d4d !important;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-weight: 800;
        padding: 8px 10px;
        border-radius: 10px;
        cursor: pointer;
        transition: background 160ms ease, color 160ms ease;
    }

    .btn-remove svg {
        width: 14px;
        height: 14px;
        display: block;
    }

    .btn-remove:hover {
        background: rgba(255, 77, 77, 0.10) !important;
        color: rgba(255, 140, 140, 1) !important;
    }

    .checkbox-group input[type="checkbox"] {
        width: 16px;
        height: 16px;
        accent-color: #3b82f6;
    }

    .checkbox-group label {
        color: rgba(232, 236, 255, 0.78);
        font-weight: 700;
    }

    /* Switches (replace all checkboxes) */
    .switch-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .switch-text {
        color: rgba(232, 236, 255, 0.78);
        font-weight: 700;
        font-size: 0.95em;
        cursor: pointer;
        user-select: none;
        margin: 0;
    }

    .mini-switch {
        position: relative;
        width: 40px;
        height: 22px;
        flex: 0 0 auto;
        display: inline-block;
    }

    .mini-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .mini-slider {
        position: absolute;
        inset: 0;
        cursor: pointer;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.14);
        border: 1px solid rgba(42, 55, 95, 0.75);
        transition: 180ms ease;
    }

    .mini-slider::before {
        content: "";
        position: absolute;
        width: 16px;
        height: 16px;
        left: 3px;
        top: 50%;
        transform: translateY(-50%);
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.95);
        box-shadow: 0 10px 16px rgba(0, 0, 0, 0.28);
        transition: 180ms ease;
    }

    .mini-switch input:checked + .mini-slider {
        background: rgba(var(--accent-rgb), 0.35);
        border-color: rgba(var(--accent-rgb), 0.75);
    }

    .mini-switch input:checked + .mini-slider::before {
        transform: translate(18px, -50%);
        background: var(--accent);
    }

    .mini-switch input:focus + .mini-slider {
        box-shadow: 0 0 0 4px rgba(var(--accent-rgb), 0.12);
    }

    .mini-switch input:disabled + .mini-slider {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* Help section (existing markup uses inline light styles) */
    .help-section {
        background: rgba(10, 16, 35, 0.62) !important;
        border: 1px solid rgba(42, 55, 95, 0.55) !important;
        border-radius: 14px !important;
        padding: 0 !important;
        overflow: hidden;
    }

    .help-header {
        padding: 16px 18px !important;
        margin-bottom: 0 !important;
        background: rgba(255, 255, 255, 0.03);
        justify-content: space-between;
    }

    .help-section.is-open .help-header {
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .help-title {
        display: inline-flex !important;
        align-items: center;
        gap: 10px;
        color: var(--accent) !important;
        font-weight: 800 !important;
        font-size: 1.02em !important;
    }

    .help-icon {
        width: 18px;
        height: 18px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: var(--accent);
        flex: 0 0 auto;
        filter: drop-shadow(0 10px 22px rgba(var(--accent-rgb), 0.14));
    }

    .help-icon svg {
        width: 18px;
        height: 18px;
        display: block;
    }

    .help-chevron {
        width: 28px;
        height: 28px;
        display: grid;
        place-items: center;
        border-radius: 10px;
        background: transparent;
        border: 1px solid transparent;
        color: rgba(232, 236, 255, 0.70) !important;
        font-weight: 900;
        font-size: 18px;
        line-height: 1;
        user-select: none;
        transition: background 160ms ease, border-color 160ms ease, transform 160ms ease, color 160ms ease;
        transform: translateY(-1px);
    }

    .help-header:hover .help-chevron {
        color: rgba(232, 236, 255, 0.88) !important;
        background: rgba(255, 255, 255, 0.06);
        border-color: rgba(42, 55, 95, 0.55);
        transform: translateY(-2px);
    }

    .help-body {
        padding: 16px !important;
    }

    .help-section h5,
    .help-section strong {
        color: #e8ecff !important;
    }

    .help-section p,
    .help-section li {
        color: rgba(232, 236, 255, 0.72) !important;
    }

    /* Inset panels inside the help accordion (override inline white/yellow blocks) */
    .help-section div[style*="background: white"] {
        background: rgba(10, 16, 35, 0.72) !important;
        border: 1px solid rgba(42, 55, 95, 0.55) !important;
        border-left: 3px solid rgba(59, 130, 246, 0.65) !important;
        border-radius: 12px !important;
    }

    .help-section div[style*="background: #fff3cd"] {
        background: rgba(var(--accent-rgb), 0.10) !important;
        border: 1px solid rgba(var(--accent-rgb), 0.28) !important;
        border-left: 4px solid rgba(var(--accent-rgb), 0.85) !important;
        border-radius: 12px !important;
    }

    .help-section div[style*="background: #fff3cd"] strong,
    .help-section div[style*="background: #fff3cd"] p {
        color: rgba(232, 236, 255, 0.80) !important;
    }

    .help-section code,
    .help-section code[style] {
        background: rgba(255, 255, 255, 0.08) !important;
        border: 1px solid rgba(42, 55, 95, 0.55) !important;
        color: rgba(232, 236, 255, 0.92) !important;
        padding: 2px 8px !important;
        border-radius: 8px !important;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace !important;
    }

    .md-list code {
        white-space: nowrap;
    }

    /* Hint / info box under section titles (match screenshot) */
    .help-text {
        position: relative;
        margin-top: 14px !important;
        margin-bottom: 12px;
        padding: 12px 14px 12px 44px !important;
        border-radius: 12px !important;
        background: rgba(59, 130, 246, 0.10) !important;
        border: 1px solid rgba(59, 130, 246, 0.22) !important;
        border-left: 4px solid rgba(59, 130, 246, 0.85) !important;
        color: rgba(147, 197, 253, 0.95) !important;
        font-size: 0.92em !important;
        line-height: 1.4;
    }

    .help-text::before {
        content: "";
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        width: 20px;
        height: 20px;
        border-radius: 999px;
        background: rgba(59, 130, 246, 0.22);
        border: 1px solid rgba(59, 130, 246, 0.35);
        box-shadow: 0 10px 18px rgba(0, 0, 0, 0.18);
        -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='black' d='M11 17h2v-6h-2v6zm0-8h2V7h-2v2zm1 13C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm0-2a8 8 0 1 0 0-16 8 8 0 0 0 0 16z'/%3E%3C/svg%3E") center/14px 14px no-repeat;
        mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='black' d='M11 17h2v-6h-2v6zm0-8h2V7h-2v2zm1 13C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm0-2a8 8 0 1 0 0-16 8 8 0 0 0 0 16z'/%3E%3C/svg%3E") center/14px 14px no-repeat;
    }

    .help-text code {
        background: rgba(10, 16, 35, 0.72) !important;
        border: 1px solid rgba(42, 55, 95, 0.55) !important;
        color: rgba(232, 236, 255, 0.92) !important;
        padding: 2px 8px !important;
        border-radius: 8px !important;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace !important;
        font-size: 0.95em;
    }

    /* Right preview */
    .discord-preview-wrapper {
        position: sticky !important;
        top: 170px !important; /* keep below the sticky Cancel/Save bar */
        width: 100% !important;
    }

    .discord-preview-container {
        background: rgba(15, 23, 42, 0.72) !important;
        border: 1px solid rgba(42, 55, 95, 0.55) !important;
        border-radius: 16px !important;
        padding: 22px !important;
        max-width: none !important;
    }

    @media (max-width: 1200px) {
        .form-wrapper {
            grid-template-columns: 1fr !important;
        }
        .discord-preview-wrapper {
            position: relative !important;
            top: 0 !important;
            margin-top: 30px !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="stf-page">
<div class="page-header">
    <div class="page-title">
        <h1>{% if form_type == 'create' %}Create Signal Type{% else %}{% if is_locked %}View Signal Template{% else %}Edit Signal Template{% endif %}{% endif %}</h1>
        <p>Define a new signal structure, variables, and Discord output format.</p>
    </div>
    <div class="page-actions">
        <a class="btn-cancel" href="{% url 'signal_types_list' %}">Cancel</a>
        {% if is_locked %}
            <button class="btn-save" type="button" disabled>üíæ Save Signal Type</button>
        {% else %}
            <button class="btn-save" type="submit" form="signalTypeForm">üíæ Save Signal Type</button>
        {% endif %}
    </div>
</div>

<div class="form-wrapper">
    <div class="form-content">
        <div class="form-container">
            <div class="form-header">
                {% if is_locked %}
                <div style="background: rgba(var(--accent-rgb), 0.10); border: 1px solid rgba(var(--accent-rgb), 0.35); border-radius: 14px; padding: 14px 16px; margin-top: 0; text-align: left;">
                    <strong>üîí System Default Template (Read-Only)</strong>
                    <p style="margin: 8px 0 0 0; color: rgba(232, 236, 255, 0.75); font-size: 0.95em;">
                        This is a system default template. You can view it but cannot modify it. 
                        Create your own custom signal type to make changes.
                    </p>
                </div>
                {% elif is_default and can_edit_default %}
                <div style="background: rgba(16, 185, 129, 0.10); border: 1px solid rgba(16, 185, 129, 0.30); border-radius: 14px; padding: 14px 16px; margin-top: 0; text-align: left;">
                    <strong>üõ†Ô∏è System Template (Editable as Superuser)</strong>
                    <p style="margin: 8px 0 0 0; color: rgba(232, 236, 255, 0.75); font-size: 0.95em;">
                        You are a superuser, so you can edit and save system templates.
                    </p>
                </div>
                {% endif %}
            </div>

            <form method="post" id="signalTypeForm" data-read-only="{% if is_locked %}1{% else %}0{% endif %}" {% if is_locked %}onsubmit="return false;"{% endif %}>
        {% csrf_token %}

        {% if can_edit_default %}
        <div class="form-section" style="margin-bottom: 22px;">
            <div class="section-header">
                <div class="section-icon" aria-hidden="true">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2a5 5 0 0 0-5 5v3H6a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2h-1V7a5 5 0 0 0-5-5Zm-3 8V7a3 3 0 1 1 6 0v3H9Z"/></svg>
                </div>
                <h3 class="form-section-title">Ownership</h3>
            </div>
            <div class="section-divider"></div>
            <div class="form-group checkbox-group">
                <input type="checkbox" id="id_is_system" name="is_system" value="on" {% if is_system_checked %}checked{% endif %}>
                <label for="id_is_system">Save as <strong>system</strong> signal type (user = NULL)</label>
            </div>
            <small>Superusers can create/edit system templates. Uncheck to keep it as a user-owned template.</small>
        </div>
        {% endif %}
        
        <!-- Basic Information -->
        <div class="form-section">
            <div class="section-header">
                <div class="section-icon" aria-hidden="true">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M12 3 2 8l10 5 10-5-10-5zm0 7.2L4.4 8 12 4.8 19.6 8 12 10.2z"/><path fill="currentColor" d="M2 12l10 5 10-5v2l-10 5-10-5v-2z"/></svg>
                </div>
                <h3 class="form-section-title">Basic Information</h3>
            </div>
            <div class="section-divider"></div>
            
            <div class="form-group">
                <label for="{{ form.name.id_for_label }}">
                    Name *
                    {% if is_locked %}
                    <span class="lock-inline" aria-hidden="true">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M17 9h-1V7a4 4 0 0 0-8 0v2H7a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2Zm-7-2a2 2 0 1 1 4 0v2h-4V7Zm7 12H7v-8h10v8Z"/></svg>
                    </span>
                    {% endif %}
                </label>
                {% if is_locked %}
                    <div style="position: relative;">
                        <input type="text" id="{{ form.name.id_for_label }}" class="form-input" value="{{ form.name.value }}" readonly>
                    </div>
                {% else %}
                    {{ form.name }}
                {% endif %}
                {% if form.name.errors %}
                    <div class="error-message">{{ form.name.errors }}</div>
                {% endif %}
                <small>Unique name for this signal type (e.g., "Trade Alert", "Stop Loss")</small>
            </div>

            <div class="form-group">
                <label for="{{ form.color.id_for_label }}">
                    Color
                    {% if is_locked %}
                    <span class="lock-inline" aria-hidden="true">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M17 9h-1V7a4 4 0 0 0-8 0v2H7a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2Zm-7-2a2 2 0 1 1 4 0v2h-4V7Zm7 12H7v-8h10v8Z"/></svg>
                    </span>
                    {% endif %}
                </label>
                <div class="color-input-group">
                    <input type="color" id="colorPicker" value="{{ form.color.value|default:'#000000' }}" {% if is_locked %}readonly disabled style="cursor: not-allowed;"{% else %}onchange="document.getElementById('id_color').value = this.value"{% endif %}>
                    {% if is_locked %}
                        <div style="position: relative; flex: 1;">
                            <input type="text" id="id_color" class="form-input" value="{{ form.color.value|default:'#000000' }}" readonly>
                        </div>
                    {% else %}
                        {{ form.color }}
                    {% endif %}
                </div>
                {% if form.color.errors %}
                    <div class="error-message">{{ form.color.errors }}</div>
                {% endif %}
                <small>Color for Discord embed (hex format)</small>
            </div>
        </div>

        <!-- Variables Section -->
        <div class="form-section">
            <div class="section-header">
                <div class="section-icon" aria-hidden="true">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M4 6h16a1 1 0 1 1 0 2H4a1 1 0 1 1 0-2zm0 5h10a1 1 0 1 1 0 2H4a1 1 0 1 1 0-2zm0 5h16a1 1 0 1 1 0 2H4a1 1 0 1 1 0-2z"/></svg>
                </div>
                <h3 class="form-section-title">Variables</h3>
            </div>
            <div class="section-divider"></div>
            <div class="help-text">
                Variables are the data fields that users will fill in when creating a signal. 
                Use <code>{% templatetag openvariable %}variable_name{% templatetag closevariable %}</code> syntax in templates to reference these variables.
            </div>
            <div id="variablesContainer" class="dynamic-list"></div>
            {% if not is_locked %}
            <button type="button" class="btn-add-wide" onclick="addVariable()">
                <span class="plus">+</span>
                <span>Add Variable</span>
            </button>
            {% endif %}
            {{ form.variables_json }}
        </div>

        <!-- Templates Section -->
        <div class="form-section">
            <div class="section-header">
                <div class="section-icon" aria-hidden="true">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M16.5 2a1 1 0 0 1 .9.56L18 4l1.44.6a1 1 0 0 1 0 1.8L18 7l-.6 1.44a1 1 0 0 1-1.8 0L15 7l-1.44-.6a1 1 0 0 1 0-1.8L15 4l.6-1.44A1 1 0 0 1 16.5 2z"></path><path fill="currentColor" d="M3 21a1 1 0 0 1-.71-1.71l11.9-11.9a1 1 0 0 1 1.42 0l2.3 2.3a1 1 0 0 1 0 1.42l-11.9 11.9A1 1 0 0 1 3 21z"></path></svg>
                </div>
                <h3 class="form-section-title">Templates</h3>
            </div>
            <div class="section-divider"></div>
            
            <!-- Help Section: Markdown and Variables -->
            <div class="help-section" id="helpSection" style="background: #f8f9fa; border: 2px solid #667eea; border-radius: 8px; padding: 20px; margin-bottom: 25px;">
                <div class="help-header" style="display: flex; align-items: center; margin-bottom: 15px; cursor: pointer;" onclick="toggleHelpSection()">
                    <h4 class="help-title" style="margin: 0; color: #667eea; font-size: 1.1em; flex: 1;">
                        <span class="help-icon" aria-hidden="true">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path fill="currentColor" d="M9 21h6v-1H9v1zm3-20a7 7 0 0 0-4 12.75V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-3.25A7 7 0 0 0 12 1zm3 11.4-.9.75V16h-4.2v-2.85L9 12.4A5 5 0 1 1 15 12.4z"/>
                            </svg>
                        </span>
                        <span>Help: Markdown Formatting &amp; Variables</span>
                    </h4>
                    <span id="helpToggleIcon" class="help-chevron" aria-hidden="true">‚åÑ</span>
                </div>
                <div id="helpContent" class="help-body" style="display: none;">
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #333; margin-bottom: 10px; font-size: 1em;">üî§ Variables Usage</h5>
                        <p style="color: #666; margin-bottom: 10px; line-height: 1.6;">
                            Use <code style="background: #e9ecef; padding: 2px 6px; border-radius: 3px;">{% templatetag openvariable %}variable_name{% templatetag closevariable %}</code> to insert variable values in your templates. 
                            Variables are defined in the Variables section above.
                        </p>
                        <div style="background: white; padding: 12px; border-radius: 4px; border-left: 3px solid #667eea; margin-top: 10px;">
                            <strong style="color: #333;">Examples:</strong>
                            <ul style="margin: 8px 0 0 0; padding-left: 20px; color: #666;">
                                <li>Title: <code>üö® {% templatetag openvariable %}ticker{% templatetag closevariable %} Trade Alert</code></li>
                            <li>Live stock price: <code>${% templatetag openvariable %}ticker::stock_price{% templatetag closevariable %}</code> <span style="color: #6b7280;">(defaults to 0.0)</span></li>
                                <li>Description: <code>Price: ${% templatetag openvariable %}price{% templatetag closevariable %} | Strike: {% templatetag openvariable %}strike{% templatetag closevariable %}</code></li>
                                <li>Field Value: <code>{% templatetag openvariable %}expiration{% templatetag closevariable %} expires at {% templatetag openvariable %}time{% templatetag closevariable %}</code></li>
                            </ul>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #333; margin-bottom: 10px; font-size: 1em;">‚ú® Discord Markdown Formatting</h5>
                        <p style="color: #666; margin-bottom: 10px; line-height: 1.6;">
                            Discord supports basic markdown formatting. Use these syntaxes in your templates:
                        </p>
                        <div style="background: white; padding: 12px; border-radius: 4px; border-left: 3px solid #667eea;">
                            <ul class="md-list" style="margin: 0; padding-left: 18px; color: #666; line-height: 1.7;">
                                <li><code>**Bold Text**</code></li>
                                <li><code>*Italic Text*</code></li>
                                <li><code>__Underline__</code></li>
                                <li><code>`Code Block`</code></li>
                            </ul>
                        </div>
                    </div>
                    
                    <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 12px; border-radius: 4px;">
                        <strong style="color: #856404;">üí° Tip:</strong>
                        <p style="color: #856404; margin: 5px 0 0 0; line-height: 1.5;">
                            You can combine markdown with variables! For example: <code>**{% templatetag openvariable %}ticker{% templatetag closevariable %}** is trading at $**{% templatetag openvariable %}price{% templatetag closevariable %}**</code> 
                            will show the ticker and price in bold.
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="{{ form.title_template.id_for_label }}">
                    Title Template *
                    {% if is_locked %}
                    <span class="lock-inline" aria-hidden="true">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M17 9h-1V7a4 4 0 0 0-8 0v2H7a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2Zm-7-2a2 2 0 1 1 4 0v2h-4V7Zm7 12H7v-8h10v8Z"/></svg>
                    </span>
                    {% endif %}
                </label>
                {% if is_locked %}
                    <div style="position: relative;">
                        <textarea id="{{ form.title_template.id_for_label }}" class="form-textarea" readonly style="resize: none;">{{ form.title_template.value|default:'' }}</textarea>
                    </div>
                {% else %}
                    {{ form.title_template }}
                {% endif %}
                {% if form.title_template.errors %}
                    <div class="error-message">{{ form.title_template.errors }}</div>
                {% endif %}
                <small>Template for Discord embed title (e.g., "üö® {{ticker}} Trade Alert")</small>
            </div>

            <div class="form-group">
                <label for="{{ form.description_template.id_for_label }}">
                    Description Template
                    {% if is_locked %}
                    <span class="lock-inline" aria-hidden="true">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M17 9h-1V7a4 4 0 0 0-8 0v2H7a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2Zm-7-2a2 2 0 1 1 4 0v2h-4V7Zm7 12H7v-8h10v8Z"/></svg>
                    </span>
                    {% endif %}
                </label>
                {% if is_locked %}
                    <div style="position: relative;">
                        <textarea id="{{ form.description_template.id_for_label }}" class="form-textarea" readonly style="resize: none;">{{ form.description_template.value|default:'' }}</textarea>
                    </div>
                {% else %}
                    {{ form.description_template }}
                {% endif %}
                {% if form.description_template.errors %}
                    <div class="error-message">{{ form.description_template.errors }}</div>
                {% endif %}
                <small>Template for Discord embed description</small>
            </div>

            <div class="form-group">
                <label for="{{ form.footer_template.id_for_label }}">
                    Footer Template
                    {% if is_locked %}
                    <span class="lock-inline" aria-hidden="true">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M17 9h-1V7a4 4 0 0 0-8 0v2H7a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2Zm-7-2a2 2 0 1 1 4 0v2h-4V7Zm7 12H7v-8h10v8Z"/></svg>
                    </span>
                    {% endif %}
                </label>
                {% if is_locked %}
                    <div style="position: relative;">
                        <textarea id="{{ form.footer_template.id_for_label }}" class="form-textarea" readonly style="resize: none;">{{ form.footer_template.value|default:'' }}</textarea>
                    </div>
                {% else %}
                    {{ form.footer_template }}
                {% endif %}
                {% if form.footer_template.errors %}
                    <div class="error-message">{{ form.footer_template.errors }}</div>
                {% endif %}
                <small>Template for Discord embed footer</small>
            </div>

            <!-- Default Display Options -->
            <div class="form-group">
                <label style="display: block; margin-bottom: 12px; font-weight: 600;">Default Display Options</label>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div class="switch-item">
                        <label class="mini-switch">
                            {% if is_locked %}
                                <input type="checkbox" id="{{ form.show_title_default.id_for_label }}" disabled checked>
                            {% else %}
                                {{ form.show_title_default }}
                            {% endif %}
                            <span class="mini-slider"></span>
                        </label>
                        <label class="switch-text" for="{{ form.show_title_default.id_for_label }}">Show title by default</label>
                        {% if is_locked %}
                            <span class="readonly-indicator" style="position: static; margin-left: 6px;">üîí</span>
                        {% endif %}
                    </div>
                    {% if form.show_title_default.errors %}
                        <div class="error-message">{{ form.show_title_default.errors }}</div>
                    {% endif %}
                    
                    <div class="switch-item">
                        <label class="mini-switch">
                            {% if is_locked %}
                                <input type="checkbox" id="{{ form.show_description_default.id_for_label }}" disabled checked>
                            {% else %}
                                {{ form.show_description_default }}
                            {% endif %}
                            <span class="mini-slider"></span>
                        </label>
                        <label class="switch-text" for="{{ form.show_description_default.id_for_label }}">Show description by default</label>
                        {% if is_locked %}
                            <span class="readonly-indicator" style="position: static; margin-left: 6px;">üîí</span>
                        {% endif %}
                    </div>
                    {% if form.show_description_default.errors %}
                        <div class="error-message">{{ form.show_description_default.errors }}</div>
                    {% endif %}
                </div>
                <small>Default checkbox states when users select this signal type in the dashboard</small>
            </div>
        </div>

        <!-- Fields Template Section -->
        <div class="form-section">
            <div class="section-header">
                <div class="section-icon" aria-hidden="true">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M12 3 3 8l9 5 9-5-9-5z"/><path fill="currentColor" d="M3 12l9 5 9-5v2l-9 5-9-5v-2z"/></svg>
                </div>
                <h3 class="form-section-title">Discord Embed Fields</h3>
            </div>
            <div class="section-divider"></div>
            <div class="help-text">
                Define the fields that will appear in the Discord embed. Each field can have a name and value, 
                both supporting <code>{% templatetag openvariable %}variable{% templatetag closevariable %}</code> syntax. Use empty name/value for spacers.
            </div>
            <div id="fieldsContainer" class="dynamic-list"></div>
            {% if not is_locked %}
            <div class="add-actions">
                <button type="button" class="btn-add-wide" onclick="addField()">
                    <span class="plus">+</span>
                    <span>Add Field</span>
                </button>
                <button type="button" class="btn-add-wide secondary" onclick="addBlankField()">
                    <span class="plus">+</span>
                    <span>Add Blank Field</span>
                </button>
            </div>
            {% endif %}
            {{ form.fields_template_json }}
        </div>

            </form>
        </div>
    </div>

    <!-- Floating Preview Section -->
    <div class="discord-preview-wrapper">
        <div class="discord-preview-container">
            <div class="preview-header">
                <strong>Live Preview</strong>
                <div class="preview-subtitle">Updates in real-time</div>
            </div>
            <div class="preview-divider"></div>
            <div id="discordPreview" class="discord-preview">
                <div class="discord-embed">
                    <div class="discord-embed-color-bar" id="previewColorBar"></div>
                    <div class="discord-embed-content">
                        <div class="discord-embed-title" id="previewTitle">Title will appear here</div>
                        <div class="discord-embed-description" id="previewDescription"></div>
                        <div class="discord-embed-fields" id="previewFields"></div>
                        <div class="discord-embed-footer" id="previewFooter"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<script>
let variables = [];
let fields = [];
let isReadOnly = document.getElementById('signalTypeForm')?.dataset?.readOnly === '1';

// Initialize from hidden inputs (keeps this script valid JS for linters)
try {
    const rawVars = (document.getElementById('id_variables_json')?.value || '').trim();
    variables = rawVars ? JSON.parse(rawVars) : [];
} catch (e) {
    variables = [];
}

try {
    const rawFields = (document.getElementById('id_fields_template_json')?.value || '').trim();
    fields = rawFields ? JSON.parse(rawFields) : [];
} catch (e) {
    fields = [];
}

function addVariable() {
    variables.push({
        name: '',
        type: 'string',
        label: '',
        required: false,
        hint: '',
        options: '',
        default: ''
    });
    renderVariables();
}

function removeVariable(index) {
    variables.splice(index, 1);
    renderVariables();
}

function updateVariable(index, field, value) {
    if (field === 'options') {
        variables[index][field] = value.split(',').map(o => o.trim()).filter(o => o);
    } else if (field === 'required') {
        variables[index][field] = value;
    } else {
        variables[index][field] = value;
    }
    updateVariablesJSON();
    updatePreview();
}

function renderVariables() {
    const container = document.getElementById('variablesContainer');
    container.innerHTML = '';
    
    variables.forEach((var_, index) => {
        const item = document.createElement('div');
        item.className = 'dynamic-item';
        item.innerHTML = `
            <div class="dynamic-item-header">
                <span class="dynamic-item-title">Variable ${index + 1}</span>
                ${isReadOnly ? '' : `<button type="button" class="btn-remove" onclick="removeVariable(${index})">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
                        <path fill="currentColor" d="M9 3h6l1 2h4a1 1 0 1 1 0 2h-1l-1.2 14.1A2 2 0 0 1 14.8 23H9.2a2 2 0 0 1-2-1.9L6 7H5a1 1 0 1 1 0-2h4l1-2zm0 6a1 1 0 0 1 1 1v9a1 1 0 1 1-2 0v-9a1 1 0 0 1 1-1zm6 0a1 1 0 0 1 1 1v9a1 1 0 1 1-2 0v-9a1 1 0 0 1 1-1z"/>
                    </svg>
                    <span>Remove</span>
                </button>`}
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Variable Name * ${isReadOnly ? `<span class="lock-inline" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M17 9h-1V7a4 4 0 0 0-8 0v2H7a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2Zm-7-2a2 2 0 1 1 4 0v2h-4V7Zm7 12H7v-8h10v8Z"/></svg></span>` : ''}</label>
                    ${isReadOnly ? '<div style="position: relative;">' : ''}
                    <input type="text" class="form-input${isReadOnly ? ' readonly' : ''}" value="${var_.name || ''}" 
                           ${isReadOnly ? 'readonly' : 'onchange="updateVariable(' + index + ', \'name\', this.value)" oninput="updateVariable(' + index + ', \'name\', this.value)"'} 
                           placeholder="e.g., ticker, strike">
                    ${isReadOnly ? '</div>' : ''}
                    <small>Use only letters, numbers, and underscores</small>
                </div>
                <div class="form-group">
                    <label>Type * ${isReadOnly ? `<span class="lock-inline" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M17 9h-1V7a4 4 0 0 0-8 0v2H7a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2Zm-7-2a2 2 0 1 1 4 0v2h-4V7Zm7 12H7v-8h10v8Z"/></svg></span>` : ''}</label>
                    ${isReadOnly ? '<div style="position: relative;">' : ''}
                    <select class="form-select${isReadOnly ? ' readonly' : ''}" ${isReadOnly ? 'disabled' : `onchange="updateVariable(${index}, 'type', this.value); renderVariables();"`}>
                        <option value="string" ${var_.type === 'string' ? 'selected' : ''}>String</option>
                        <option value="float" ${var_.type === 'float' ? 'selected' : ''}>Float</option>
                        <option value="integer" ${var_.type === 'integer' ? 'selected' : ''}>Integer</option>
                        <option value="date" ${var_.type === 'date' ? 'selected' : ''}>Date</option>
                        <option value="boolean" ${var_.type === 'boolean' ? 'selected' : ''}>Boolean</option>
                        <option value="text" ${var_.type === 'text' ? 'selected' : ''}>Text</option>
                        <option value="select" ${var_.type === 'select' ? 'selected' : ''}>Select</option>
                        <option value="ticker_select" ${var_.type === 'ticker_select' ? 'selected' : ''}>Ticker Select</option>
                        <option value="ticker_type" ${var_.type === 'ticker_type' ? 'selected' : ''}>Ticker Type</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Label * ${isReadOnly ? `<span class="lock-inline" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M17 9h-1V7a4 4 0 0 0-8 0v2H7a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2Zm-7-2a2 2 0 1 1 4 0v2h-4V7Zm7 12H7v-8h10v8Z"/></svg></span>` : ''}</label>
                    <input type="text" class="form-input${isReadOnly ? ' readonly' : ''}" value="${var_.label || ''}" 
                           ${isReadOnly ? 'readonly' : 'onchange="updateVariable(' + index + ', \'label\', this.value)"'} 
                           placeholder="e.g., Ticker Symbol">
                    ${isReadOnly ? '' : ''}
                </div>
                <div class="form-group">
                    <label>Default Value ${isReadOnly ? `<span class="lock-inline" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M17 9h-1V7a4 4 0 0 0-8 0v2H7a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2Zm-7-2a2 2 0 1 1 4 0v2h-4V7Zm7 12H7v-8h10v8Z"/></svg></span>` : ''}</label>
                    <input type="text" class="form-input${isReadOnly ? ' readonly' : ''}" value="${var_.default || ''}" 
                           ${isReadOnly ? 'readonly' : 'onchange="updateVariable(' + index + ', \'default\', this.value)" oninput="updateVariable(' + index + ', \'default\', this.value)"'}>
                    ${isReadOnly ? '' : ''}
                </div>
            </div>
            ${(var_.type === 'select' || var_.type === 'ticker_select') ? `
            <div class="form-group">
                <label>${var_.type === 'ticker_select' ? 'Custom Tickers (optional)' : 'Options * (comma-separated)'} ${isReadOnly ? `<span class="lock-inline" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M17 9h-1V7a4 4 0 0 0-8 0v2H7a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2Zm-7-2a2 2 0 1 1 4 0v2h-4V7Zm7 12H7v-8h10v8Z"/></svg></span>` : ''}</label>
                <input type="text" class="form-input${isReadOnly ? ' readonly' : ''}" value="${(var_.options || []).join(', ')}" 
                       ${isReadOnly ? 'readonly' : 'onchange="updateVariable(' + index + ', \'options\', this.value)"'} 
                       placeholder="${var_.type === 'ticker_select' ? 'e.g., AAPL, TSLA, NVDA (leave empty for all US tickers)' : 'e.g., PUT, CALL'}">
                ${isReadOnly ? '' : ''}
            </div>
            ` : ''}
            <div class="form-row">
                <div class="form-group">
                    <label>Hint/Help Text ${isReadOnly ? `<span class="lock-inline" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M17 9h-1V7a4 4 0 0 0-8 0v2H7a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2Zm-7-2a2 2 0 1 1 4 0v2h-4V7Zm7 12H7v-8h10v8Z"/></svg></span>` : ''}</label>
                    <textarea class="form-textarea${isReadOnly ? ' readonly' : ''}" rows="2" 
                              ${isReadOnly ? 'readonly style="resize: none;"' : 'onchange="updateVariable(' + index + ', \'hint\', this.value)"'} 
                              placeholder="Optional help text">${var_.hint || ''}</textarea>
                    ${isReadOnly ? '' : ''}
                </div>
                <div class="form-group">
                    <div class="switch-item">
                        <label class="mini-switch">
                            <input type="checkbox" id="required_${index}" ${var_.required ? 'checked' : ''} 
                                   ${isReadOnly ? 'disabled' : `onchange="updateVariable(${index}, 'required', this.checked)"`}>
                            <span class="mini-slider"></span>
                        </label>
                        <label class="switch-text" for="required_${index}">Required Field</label>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(item);
    });
    
    if (variables.length === 0) {
        container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No variables added yet. Click "Add Variable" to get started.</p>';
    }
    
    updateVariablesJSON();
}

function addField() {
    fields.push({
        name: '',
        value: '',
        inline: false,
        optional: false
    });
    renderFields();
}

function addBlankField() {
    fields.push({
        name: '',
        value: '\u200b',  // Zero-width space for blank line in Discord
        inline: false,
        optional: false
    });
    renderFields();
}

function removeField(index) {
    fields.splice(index, 1);
    renderFields();
}

function updateField(index, field, value) {
    // Prevent editing blank fields
    const currentField = fields[index];
    const isBlankField = (!currentField.name || currentField.name.trim() === '') && 
                        currentField.value === '\u200b';
    if (isBlankField && field !== 'inline') {
        alert('Blank spacer fields cannot be edited. They are read-only.');
        renderFields(); // Re-render to reset any changes
        return;
    }
    
    if (field === 'inline' || field === 'optional') {
        fields[index][field] = value;
    } else {
        fields[index][field] = value;
    }
    updateFieldsJSON();
    updatePreview();
}

function renderFields() {
    const container = document.getElementById('fieldsContainer');
    container.innerHTML = '';
    
    fields.forEach((field, index) => {
        // Check if this is a blank field (empty name and zero-width space value)
        // Only mark as blank if value is specifically the zero-width space character
        const isBlankField = (!field.name || field.name.trim() === '') && 
                            field.value === '\u200b';
        const fieldIsReadOnly = isReadOnly || isBlankField;
        
        const item = document.createElement('div');
        item.className = 'dynamic-item';
        if (isBlankField) {
            item.style.border = '2px dashed #6c757d';
            item.style.backgroundColor = '#f0f0f0';
            item.style.opacity = '0.95';
            item.style.position = 'relative';
        }
        item.innerHTML = `
            <div class="dynamic-item-header">
                <span class="dynamic-item-title">
                    Field ${index + 1}
                    ${isBlankField ? '<span style="background: #6c757d; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75em; margin-left: 10px;">Blank Spacer</span>' : ''}
                </span>
                ${isReadOnly ? '' : `<button type="button" class="btn-remove" onclick="removeField(${index})">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
                        <path fill="currentColor" d="M9 3h6l1 2h4a1 1 0 1 1 0 2h-1l-1.2 14.1A2 2 0 0 1 14.8 23H9.2a2 2 0 0 1-2-1.9L6 7H5a1 1 0 1 1 0-2h4l1-2zm0 6a1 1 0 0 1 1 1v9a1 1 0 1 1-2 0v-9a1 1 0 0 1 1-1zm6 0a1 1 0 0 1 1 1v9a1 1 0 1 1-2 0v-9a1 1 0 0 1 1-1z"/>
                    </svg>
                    <span>Remove</span>
                </button>`}
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label style="${isBlankField ? 'color: #6c757d; font-weight: 600;' : ''}">
                        Field Name ${isBlankField ? '(Blank Spacer)' : ''}
                        ${fieldIsReadOnly ? `<span class="lock-inline" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M17 9h-1V7a4 4 0 0 0-8 0v2H7a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2Zm-7-2a2 2 0 1 1 4 0v2h-4V7Zm7 12H7v-8h10v8Z"/></svg></span>` : ''}
                    </label>
                    ${fieldIsReadOnly ? '<div style="position: relative;">' : ''}
                    <input type="text" class="form-input${fieldIsReadOnly ? ' readonly' : ''}" value="${(field.name || '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}" 
                           ${fieldIsReadOnly ? 'readonly disabled' : 'onchange="updateField(' + index + ', \'name\', this.value)" oninput="updateField(' + index + ', \'name\', this.value)"'} 
                           placeholder="${isBlankField ? 'Blank spacer field (read-only)' : 'e.g., Ticker: {{ticker}}'}"
                           style="${isBlankField ? 'background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%) !important; border: 2px solid #adb5bd !important; color: #6c757d !important; cursor: not-allowed !important;' : ''}">
                    ${fieldIsReadOnly ? '</div>' : ''}
                    <small style="${isBlankField ? 'color: #6c757d; font-style: italic;' : ''}">${isBlankField ? '‚ö†Ô∏è This is a blank spacer field (read-only - cannot be edited)' : 'Can use {% templatetag openvariable %}variable{% templatetag closevariable %} syntax'}</small>
                </div>
                <div class="form-group">
                    <div class="switch-item">
                        <label class="mini-switch">
                            <input type="checkbox" id="inline_${index}" ${field.inline ? 'checked' : ''} 
                                   ${fieldIsReadOnly ? 'disabled' : `onchange="updateField(${index}, 'inline', this.checked)"`}>
                            <span class="mini-slider"></span>
                        </label>
                        <label class="switch-text" for="inline_${index}">Inline Field</label>
                    </div>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <div class="switch-item">
                        <label class="mini-switch">
                            <input type="checkbox" id="optional_${index}" ${field.optional ? 'checked' : ''} 
                                   ${fieldIsReadOnly ? 'disabled' : `onchange="updateField(${index}, 'optional', this.checked)"`}>
                            <span class="mini-slider"></span>
                        </label>
                        <label class="switch-text" for="optional_${index}">Optional Field</label>
                    </div>
                    <small style="${isBlankField ? 'color: #6c757d; font-style: italic;' : ''}">${isBlankField ? '' : 'Optional fields can be shown/hidden in the message'}</small>
                </div>
            </div>
            <div class="form-group">
                <label style="${isBlankField ? 'color: #6c757d; font-weight: 600;' : ''}">
                    Field Value ${isBlankField ? '(Blank Spacer)' : ''}
                    ${fieldIsReadOnly ? `<span class="lock-inline" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M17 9h-1V7a4 4 0 0 0-8 0v2H7a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2Zm-7-2a2 2 0 1 1 4 0v2h-4V7Zm7 12H7v-8h10v8Z"/></svg></span>` : ''}
                </label>
                ${fieldIsReadOnly ? '<div style="position: relative;">' : ''}
                <textarea class="form-textarea${fieldIsReadOnly ? ' readonly' : ''}" rows="3" 
                          ${fieldIsReadOnly ? 'readonly disabled style="resize: none;' + (isBlankField ? ' background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%) !important; border: 2px solid #adb5bd !important; color: #6c757d !important; cursor: not-allowed !important;' : '') + '"' : 'onchange="updateField(' + index + ', \'value\', this.value)" oninput="updateField(' + index + ', \'value\', this.value)"'} 
                          placeholder="${isBlankField ? 'Blank spacer field (read-only)' : 'e.g., {% templatetag openvariable %}price{% templatetag closevariable %} or static text'}">${(field.value || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
                ${fieldIsReadOnly ? '</div>' : ''}
                <small style="${isBlankField ? 'color: #6c757d; font-style: italic;' : ''}">${isBlankField ? '‚ö†Ô∏è Blank spacer field creates empty space in Discord embed (read-only - cannot be edited)' : 'Can use {% templatetag openvariable %}variable{% templatetag closevariable %} syntax or be empty for name-only fields'}</small>
            </div>
        `;
        container.appendChild(item);
    });
    
    if (fields.length === 0) {
        container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No fields added yet. Click "Add Field" to get started.</p>';
    }
    
    updateFieldsJSON();
}

function updateVariablesJSON() {
    document.getElementById('id_variables_json').value = JSON.stringify(variables);
    updatePreview();
}

function updateFieldsJSON() {
    document.getElementById('id_fields_template_json').value = JSON.stringify(fields);
    updatePreview();
}

// Generate sample data for variables based on their types
function generateSampleData() {
    const sampleData = {};
    variables.forEach(v => {
        if (!v.name) return;
        switch(v.type) {
            case 'string':
                sampleData[v.name] = v.default || 'Sample ' + (v.label || v.name);
                break;
            case 'float':
                sampleData[v.name] = v.default || '123.45';
                break;
            case 'integer':
                sampleData[v.name] = v.default || '100';
                break;
            case 'date':
                sampleData[v.name] = v.default || new Date().toLocaleDateString();
                break;
            case 'boolean':
                sampleData[v.name] = v.default || 'true';
                break;
            case 'text':
                sampleData[v.name] = v.default || 'Sample text content';
                break;
            case 'select':
                const options = Array.isArray(v.options) ? v.options : (v.options || '').split(',').map(o => o.trim());
                sampleData[v.name] = v.default || (options[0] || 'Option');
                break;
            case 'ticker_select': {
                const options = Array.isArray(v.options) ? v.options : (v.options || '').split(',').map(o => o.trim());
                sampleData[v.name] = v.default || (options[0] || 'AAPL');
                break;
            }
            case 'ticker_type':
                sampleData[v.name] = v.default || 'AAPL';
                break;
            default:
                sampleData[v.name] = v.default || 'Sample';
        }
    });

    // Defaults for namespaced option helpers (used via var::strike / var::expiration / var::option_type)
    if (sampleData['expiration'] === undefined) {
        // YYYY-MM-DD
        const d = new Date();
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        sampleData['expiration'] = `${y}-${m}-${day}`;
    }
    if (sampleData['strike'] === undefined) {
        sampleData['strike'] = '0.000';
    }
    if (sampleData['option_type'] === undefined) {
        sampleData['option_type'] = 'CALL';
    }
    if (sampleData['option_price'] === undefined) {
        sampleData['option_price'] = '0.000';
    }
    if (sampleData['tp1_per'] === undefined) sampleData['tp1_per'] = '10';
    if (sampleData['tp2_per'] === undefined) sampleData['tp2_per'] = '20';
    if (sampleData['tp3_per'] === undefined) sampleData['tp3_per'] = '30';
    if (sampleData['sl_per'] === undefined) sampleData['sl_per'] = '10';
    if (sampleData['tp1_takeoff_per'] === undefined) sampleData['tp1_takeoff_per'] = '50';
    if (sampleData['tp2_takeoff_per'] === undefined) sampleData['tp2_takeoff_per'] = '25';
    if (sampleData['tp3_takeoff_per'] === undefined) sampleData['tp3_takeoff_per'] = '25';
    if (sampleData['tp1_price'] === undefined) sampleData['tp1_price'] = '0.000';
    if (sampleData['tp2_price'] === undefined) sampleData['tp2_price'] = '0.000';
    if (sampleData['tp3_price'] === undefined) sampleData['tp3_price'] = '0.000';
    if (sampleData['sl_price'] === undefined) sampleData['sl_price'] = '0.000';

    return sampleData;
}

// Render template by replacing {% templatetag openvariable %}variable{% templatetag closevariable %} placeholders
// (supports {% templatetag openvariable %}var::stock_price{% templatetag closevariable %})
function renderTemplate(template, data) {
    if (!template) return '';
    return template.replace(/\{\{(\w+)(?:::(\w+))?\}\}/g, (match, varName, modifier) => {
        if (modifier === 'stock_price') {
            // Template-builder preview doesn't fetch live quotes; default to 0.0
            return '0.000';
        }
        if (modifier === 'company_name') {
            // Template-builder preview doesn't fetch company details; show placeholder.
            return 'Company Name';
        }
        // Defaults for namespaced option helpers
        if (modifier === 'expiration') return data.expiration ?? (new Date().toISOString().slice(0, 10));
        if (modifier === 'strike') return data.strike ?? '0.000';
        if (modifier === 'option_type') return data.option_type ?? 'CALL';
        if (modifier === 'option_price') return data.option_price ?? '0.000';
        if (modifier && ['tp1_per','tp2_per','tp3_per','sl_per'].includes(modifier)) {
            const v = data[modifier];
            if (v === undefined || v === null || String(v).trim() === '') return '0%';
            const s = String(v).trim();
            return s.endsWith('%') ? s : `${s}%`;
        }
        if (modifier && ['tp1_price','tp2_price','tp3_price','sl_price'].includes(modifier)) return data[modifier] ?? '0.000';
        if (modifier && (modifier in data)) {
            // Allow {% templatetag openvariable %}ticker::strike{% templatetag closevariable %} style access (treat modifier as the real variable name).
            return data[modifier];
        }
        return data[varName] !== undefined ? data[varName] : match;
    });
}

// Parse Discord markdown to HTML
function parseDiscordMarkdown(text) {
    if (!text) return '';
    
    // Escape HTML first to prevent XSS
    let html = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    
    // Code blocks (```code```) - must be processed before inline code
    html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
    
    // Inline code (`code`) - protect code from other markdown
    const codeBlocks = [];
    html = html.replace(/`([^`\n]+)`/g, (match, code) => {
        const placeholder = `__CODE_BLOCK_${codeBlocks.length}__`;
        codeBlocks.push(`<code>${code}</code>`);
        return placeholder;
    });
    
    // Bold and italic combinations (***text***)
    html = html.replace(/\*\*\*([^*]+)\*\*\*/g, '<strong><em>$1</em></strong>');
    
    // Bold (**text**)
    html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    
    // Bold (__text__) - Discord uses __ for bold
    html = html.replace(/__(?![_*])([^_]+)__(?![_*])/g, '<strong>$1</strong>');
    
    // Underline (__text__) - Discord doesn't have underline in standard markdown, but we'll support it
    // Actually, Discord uses __ for bold, not underline. But we can add underline support
    // We'll use a different syntax for underline: <u>text</u> or we can use double underscores that aren't bold
    
    // Italic (*text*)
    html = html.replace(/(?<!\*)\*([^*\n]+)\*(?!\*)/g, '<em>$1</em>');
    
    // Italic (_text_) - but not if it's part of bold
    html = html.replace(/(?<!_)_([^_\n]+)_(?!_)/g, '<em>$1</em>');
    
    // Strikethrough (~~text~~)
    html = html.replace(/~~([^~]+)~~/g, '<s>$1</s>');
    
    // Restore code blocks
    codeBlocks.forEach((code, index) => {
        html = html.replace(`__CODE_BLOCK_${index}__`, code);
    });
    
    // Preserve newlines as <br>
    html = html.replace(/\n/g, '<br>');
    
    return html;
}

// Update Discord embed preview
function updatePreview() {
    const sampleData = generateSampleData();
    
    // Update color bar
    const color = document.getElementById('id_color').value || '#000000';
    document.getElementById('previewColorBar').style.backgroundColor = color;
    
    // Update title
    const titleTemplate = document.getElementById('id_title_template').value || '';
    const title = renderTemplate(titleTemplate, sampleData);
    const titleEl = document.getElementById('previewTitle');
    if (title) {
        titleEl.innerHTML = parseDiscordMarkdown(title);
        titleEl.style.display = 'block';
    } else {
        titleEl.style.display = 'none';
    }
    
    // Update description
    const descTemplate = document.getElementById('id_description_template').value || '';
    const description = renderTemplate(descTemplate, sampleData);
    const descEl = document.getElementById('previewDescription');
    if (description) {
        descEl.innerHTML = parseDiscordMarkdown(description);
        descEl.style.display = 'block';
    } else {
        descEl.style.display = 'none';
    }
    
    // Update fields
    const fieldsContainer = document.getElementById('previewFields');
    fieldsContainer.innerHTML = '';
    
    let currentInlineGroup = null;
    
    // First pass: filter out consecutive blank spacers
    const filteredFields = [];
    let prevWasBlank = false;
    fields.forEach((field, index) => {
        const fieldName = renderTemplate(field.name || '', sampleData);
        const fieldValue = renderTemplate(field.value || '', sampleData);
        
        // Check if this is a blank spacer (empty name and value is '\u200b')
        const isBlankSpacer = (!fieldName || !fieldName.trim()) && 
                              (fieldValue === '\u200b' || (fieldValue && fieldValue.trim() === '\u200b'));
        
        // Skip consecutive blank spacers
        if (isBlankSpacer && prevWasBlank) {
            return;
        }
        prevWasBlank = isBlankSpacer;
        
        // Skip empty fields (spacers with no name or value)
        if (!fieldName && !fieldValue) {
            return;
        }
        
        filteredFields.push({field: field, fieldName: fieldName, fieldValue: fieldValue, index: index});
    });
    
    // Remove trailing blank spacers
    while (filteredFields.length > 0) {
        const last = filteredFields[filteredFields.length - 1];
        const isBlankSpacer = (!last.fieldName || !last.fieldName.trim()) && 
                             (last.fieldValue === '\u200b' || (last.fieldValue && last.fieldValue.trim() === '\u200b'));
        if (isBlankSpacer) {
            filteredFields.pop();
        } else {
            break;
        }
    }
    
    filteredFields.forEach((item, filteredIndex) => {
        const {field, fieldName, fieldValue, index} = item;
        
        const fieldEl = document.createElement('div');
        fieldEl.className = 'discord-embed-field';
        
        // Check if this is an inline field
        if (field.inline) {
            // If previous field was not inline, start a new inline group
            if (!currentInlineGroup || (filteredIndex > 0 && !filteredFields[filteredIndex - 1].field.inline)) {
                currentInlineGroup = document.createElement('div');
                currentInlineGroup.style.display = 'flex';
                currentInlineGroup.style.flexWrap = 'wrap';
                currentInlineGroup.style.gap = '16px';
                fieldsContainer.appendChild(currentInlineGroup);
            }
            // Check if current group already has 3 fields, start a new row
            if (currentInlineGroup && currentInlineGroup.children.length >= 3) {
                currentInlineGroup = document.createElement('div');
                currentInlineGroup.style.display = 'flex';
                currentInlineGroup.style.flexWrap = 'wrap';
                currentInlineGroup.style.gap = '16px';
                fieldsContainer.appendChild(currentInlineGroup);
            }
            fieldEl.classList.add('discord-embed-field-inline');
        } else {
            // Non-inline field, close any existing inline group
            currentInlineGroup = null;
        }
        
        const nameEl = document.createElement('div');
        nameEl.className = 'discord-embed-field-name';
        nameEl.innerHTML = fieldName ? parseDiscordMarkdown(fieldName) : '\u200b'; // Zero-width space if empty
        
        const valueEl = document.createElement('div');
        valueEl.className = 'discord-embed-field-value';
        valueEl.innerHTML = fieldValue ? parseDiscordMarkdown(fieldValue) : '\u200b';
        
        fieldEl.appendChild(nameEl);
        fieldEl.appendChild(valueEl);
        
        if (field.inline && currentInlineGroup) {
            currentInlineGroup.appendChild(fieldEl);
        } else {
            fieldsContainer.appendChild(fieldEl);
        }
    });
    
    // Update footer
    const footerTemplate = document.getElementById('id_footer_template').value || '';
    const footer = renderTemplate(footerTemplate, sampleData);
    const footerEl = document.getElementById('previewFooter');
    if (footer) {
        footerEl.innerHTML = parseDiscordMarkdown(footer);
        footerEl.style.display = 'block';
    } else {
        footerEl.style.display = 'none';
    }
}

// Sync color picker with text input and update preview
document.getElementById('id_color').addEventListener('input', function(e) {
    document.getElementById('colorPicker').value = e.target.value;
    updatePreview();
});

// Add event listeners to all form inputs for real-time preview
function setupPreviewListeners() {
    // Title template
    const titleInput = document.getElementById('id_title_template');
    if (titleInput) {
        titleInput.addEventListener('input', updatePreview);
        titleInput.addEventListener('change', updatePreview);
    }
    
    // Description template
    const descInput = document.getElementById('id_description_template');
    if (descInput) {
        descInput.addEventListener('input', updatePreview);
        descInput.addEventListener('change', updatePreview);
    }
    
    // Footer template
    const footerInput = document.getElementById('id_footer_template');
    if (footerInput) {
        footerInput.addEventListener('input', updatePreview);
        footerInput.addEventListener('change', updatePreview);
    }
    
    // Color input
    const colorInput = document.getElementById('id_color');
    if (colorInput) {
        colorInput.addEventListener('input', updatePreview);
    }
    
    const colorPicker = document.getElementById('colorPicker');
    if (colorPicker) {
        colorPicker.addEventListener('change', function(e) {
            document.getElementById('id_color').value = e.target.value;
            updatePreview();
        });
    }
}

// Toggle help section
function toggleHelpSection() {
    const helpContent = document.getElementById('helpContent');
    const helpToggleIcon = document.getElementById('helpToggleIcon');
    const helpSection = document.getElementById('helpSection');
    if (helpContent && helpToggleIcon) {
        if (helpContent.style.display === 'none') {
            helpContent.style.display = 'block';
            helpToggleIcon.textContent = '‚åÉ';
            if (helpSection) helpSection.classList.add('is-open');
        } else {
            helpContent.style.display = 'none';
            helpToggleIcon.textContent = '‚åÑ';
            if (helpSection) helpSection.classList.remove('is-open');
        }
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    renderVariables();
    renderFields();
    
    // Sync initial color
    const colorValue = document.getElementById('id_color').value || '#000000';
    document.getElementById('colorPicker').value = colorValue;
    
    // Setup preview listeners
    setupPreviewListeners();
    
    // Initial preview update
    updatePreview();
});
</script>
{% endblock %}

