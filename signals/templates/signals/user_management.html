{% extends 'signals/base.html' %}

{% block title %}User Management - Crowned Trader Dashboard{% endblock %}

{% block breadcrumbs %}
<a href="{% url 'dashboard' %}">Dashboard</a>
<span>/</span>
<span>User Management</span>
{% endblock %}

{% block extra_css %}
<style>
    .um-page {
        width: 100%;
        max-width: 1840px;
        margin: 0 auto;
    }

    .um-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 18px;
        margin-bottom: 22px;
    }

    .um-title h1 {
        margin: 0 0 8px 0;
        color: #e8ecff;
        font-size: 2.2em;
        font-weight: 800;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .um-icon {
        width: 28px;
        height: 28px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: var(--accent);
        filter: drop-shadow(0 10px 22px rgba(var(--accent-rgb), 0.18));
    }

    .um-icon svg {
        width: 24px;
        height: 24px;
        display: block;
    }

    .um-title p {
        margin: 0;
        color: rgba(232, 236, 255, 0.65);
        font-size: 1.05em;
        max-width: 760px;
    }

    .um-create-btn {
        background: var(--accent);
        color: #0b1020;
        border: none;
        border-radius: 12px;
        padding: 12px 18px;
        font-weight: 800;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 10px 26px rgba(var(--accent-rgb), 0.18);
        transition: transform 160ms ease, box-shadow 160ms ease, background 160ms ease;
        white-space: nowrap;
        height: 44px;
    }

    .um-create-btn:hover {
        transform: translateY(-1px);
        background: color-mix(in srgb, var(--accent) 85%, #ffffff 15%);
        box-shadow: 0 14px 30px rgba(var(--accent-rgb), 0.22);
    }

    .um-filter-card {
        background: rgba(15, 23, 42, 0.72);
        border: 1px solid rgba(42, 55, 95, 0.55);
        border-radius: 16px;
        padding: 18px;
        margin-bottom: 18px;
        box-shadow: 0 10px 26px rgba(0, 0, 0, 0.22);
    }

    .um-filter-row {
        display: grid;
        grid-template-columns: 1fr 220px 120px;
        gap: 14px;
        align-items: center;
    }

    .um-input-wrap {
        position: relative;
    }

    .um-input-icon {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        width: 18px;
        height: 18px;
        color: rgba(232, 236, 255, 0.55);
        pointer-events: none;
    }

    .um-input,
    .um-select {
        width: 100%;
        height: 44px;
        border-radius: 12px;
        border: 1px solid rgba(42, 55, 95, 0.65);
        background: rgba(10, 16, 35, 0.72);
        color: #e8ecff;
        padding: 0 14px;
        font-weight: 600;
        transition: border-color 180ms ease, box-shadow 180ms ease, background 180ms ease;
    }

    .um-input {
        padding-left: 44px;
    }

    .um-input::placeholder {
        color: rgba(232, 236, 255, 0.45);
        font-weight: 500;
    }

    .um-input:focus,
    .um-select:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(var(--accent-rgb), 0.10);
    }

    .um-select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 12 12'%3E%3Cpath fill='%23cbd5e1' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        padding-right: 40px;
        cursor: pointer;
    }

    .um-select option {
        background: #050816;
        color: #e8ecff;
    }

    .um-search-btn {
        height: 44px;
        border-radius: 12px;
        border: 1px solid rgba(42, 55, 95, 0.65);
        background: rgba(255, 255, 255, 0.06);
        color: #e8ecff;
        font-weight: 800;
        cursor: pointer;
        transition: background 160ms ease, border-color 160ms ease, transform 160ms ease;
    }

    .um-search-btn:hover {
        background: rgba(255, 255, 255, 0.09);
        border-color: rgba(42, 55, 95, 0.85);
        transform: translateY(-1px);
    }

    .um-table-card {
        background: rgba(15, 23, 42, 0.72);
        border: 1px solid rgba(42, 55, 95, 0.55);
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 10px 26px rgba(0, 0, 0, 0.22);
    }

    .um-table {
        width: 100%;
        border-collapse: collapse;
    }

    .um-table thead th {
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-size: 0.78em;
        color: rgba(232, 236, 255, 0.62);
        font-weight: 800;
        padding: 16px 18px;
        background: rgba(255, 255, 255, 0.03);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .um-table tbody td {
        padding: 18px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        color: rgba(232, 236, 255, 0.78);
        vertical-align: middle;
    }

    .um-table tbody tr:hover {
        background: rgba(255, 255, 255, 0.03);
    }

    .um-username {
        color: #e8ecff;
        font-weight: 800;
    }

    .um-email {
        color: rgba(147, 197, 253, 0.85);
        font-weight: 600;
    }

    .chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border-radius: 10px;
        border: 1px solid rgba(232, 236, 255, 0.20);
        background: rgba(10, 16, 35, 0.62);
        padding: 6px 10px;
        color: rgba(232, 236, 255, 0.85);
        font-weight: 700;
        font-size: 0.9em;
        line-height: 1.1;
        width: fit-content;
        max-width: 100%;
    }

    .chip .chip-badge {
        background: var(--accent);
        color: #0b1020;
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 0.78em;
        font-weight: 900;
        white-space: nowrap;
    }

    .chip .chip-icon {
        width: 16px;
        height: 16px;
        color: rgba(167, 139, 250, 0.9);
        flex: 0 0 auto;
    }

    .chips-col {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .badge-pill {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 4px 12px;
        border-radius: 999px;
        font-size: 0.85em;
        font-weight: 800;
        border: 1px solid rgba(42, 55, 95, 0.55);
        background: rgba(255, 255, 255, 0.04);
        width: fit-content;
        white-space: nowrap;
    }

    .badge-active {
        color: rgba(52, 211, 153, 0.95);
        border-color: rgba(16, 185, 129, 0.35);
        background: rgba(16, 185, 129, 0.10);
    }

    .badge-inactive {
        color: rgba(255, 140, 140, 0.95);
        border-color: rgba(255, 77, 77, 0.35);
        background: rgba(255, 77, 77, 0.10);
    }

    .badge-superuser {
        color: var(--accent);
        border-color: rgba(var(--accent-rgb), 0.45);
        background: rgba(var(--accent-rgb), 0.10);
    }

    .badge-admin {
        color: rgba(147, 197, 253, 0.95);
        border-color: rgba(96, 165, 250, 0.35);
        background: rgba(59, 130, 246, 0.10);
    }

    .badge-user {
        color: rgba(232, 236, 255, 0.78);
        border-color: rgba(232, 236, 255, 0.20);
        background: rgba(255, 255, 255, 0.04);
    }

    .um-actions {
        display: flex;
        gap: 14px;
        align-items: center;
        justify-content: flex-end;
    }

    .icon-btn {
        width: 34px;
        height: 34px;
        border-radius: 10px;
        display: grid;
        place-items: center;
        border: 1px solid rgba(42, 55, 95, 0.55);
        background: rgba(255, 255, 255, 0.04);
        color: rgba(232, 236, 255, 0.70);
        transition: background 160ms ease, border-color 160ms ease, transform 160ms ease, color 160ms ease;
        text-decoration: none;
        cursor: pointer;
    }

    .icon-btn:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(42, 55, 95, 0.85);
        transform: translateY(-1px);
        color: rgba(232, 236, 255, 0.92);
    }

    .icon-btn.danger {
        color: rgba(255, 140, 140, 0.95);
        border-color: rgba(255, 77, 77, 0.35);
        background: rgba(255, 77, 77, 0.06);
    }

    .icon-btn.danger:hover {
        background: rgba(255, 77, 77, 0.12);
        border-color: rgba(255, 77, 77, 0.55);
    }

    .icon-btn svg {
        width: 16px;
        height: 16px;
        display: block;
    }

    .um-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        padding: 14px 18px;
        color: rgba(232, 236, 255, 0.60);
        border-top: 1px solid rgba(255, 255, 255, 0.06);
    }

    .um-pager {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .pager-btn {
        width: 36px;
        height: 36px;
        border-radius: 12px;
        border: 1px solid rgba(42, 55, 95, 0.55);
        background: rgba(255, 255, 255, 0.04);
        color: rgba(232, 236, 255, 0.75);
        display: grid;
        place-items: center;
        text-decoration: none;
        transition: background 160ms ease, border-color 160ms ease, transform 160ms ease;
    }

    .pager-btn:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(42, 55, 95, 0.85);
        transform: translateY(-1px);
    }

    .pager-btn.disabled {
        opacity: 0.45;
        pointer-events: none;
    }

    .page-pill {
        width: 36px;
        height: 36px;
        border-radius: 12px;
        background: var(--accent);
        color: #0b1020;
        display: grid;
        place-items: center;
        font-weight: 900;
    }

    @media (max-width: 900px) {
        .um-filter-row {
            grid-template-columns: 1fr;
        }
        .um-actions {
            justify-content: flex-start;
        }
        .um-footer {
            flex-direction: column;
            align-items: flex-start;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="um-page">
    <div class="um-header">
        <div class="um-title">
            <h1>
                <span class="um-icon" aria-hidden="true">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M16 11c1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3 1.34 3 3 3zM8 11c1.66 0 3-1.34 3-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5C15 14.17 10.33 13 8 13zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                    </svg>
                </span>
                <span>User Management</span>
            </h1>
            <p>Manage user accounts, assign roles, and configure Discord channel access permissions.</p>
        </div>

        <a href="{% url 'user_create' %}" class="um-create-btn">
            <span style="font-size: 18px; font-weight: 900;">＋</span>
            <span>Create New User</span>
        </a>
    </div>

    <div class="um-filter-card">
        <form method="get" action="{% url 'user_management' %}">
            <div class="um-filter-row">
                <div class="um-input-wrap">
                    <span class="um-input-icon" aria-hidden="true">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M10 2a8 8 0 1 0 5.3 14l4.2 4.2a1 1 0 0 0 1.4-1.4l-4.2-4.2A8 8 0 0 0 10 2zm0 2a6 6 0 1 1 0 12 6 6 0 0 1 0-12z"/>
                        </svg>
                    </span>
                    <input class="um-input" type="text" name="search" placeholder="Search users by username or email..." value="{{ search_query }}">
                </div>

                <select class="um-select" name="role" aria-label="Role filter">
                    <option value="all" {% if role_filter == 'all' %}selected{% endif %}>All Roles</option>
                    <option value="superuser" {% if role_filter == 'superuser' %}selected{% endif %}>Superuser</option>
                    <option value="user" {% if role_filter == 'user' %}selected{% endif %}>User</option>
                </select>

                <button class="um-search-btn" type="submit">Search</button>
            </div>
        </form>
    </div>

    {% if users %}
    <div class="um-table-card">
        <table class="um-table">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Discord Channels</th>
                    <th>Status</th>
                    <th>Role</th>
                    <th>Date Joined</th>
                    <th style="text-align:right;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td class="um-username">{{ user.username }}</td>
                    <td class="um-email">{{ user.email|default:"—" }}</td>
                    <td>
                        {% if user.discord_channels.all %}
                            <div class="chips-col">
                                {% for channel in user.discord_channels.all %}
                                    <div class="chip">
                                        <span class="chip-icon" aria-hidden="true">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                                <path fill="currentColor" d="M20 4H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h14l4-4V6a2 2 0 0 0-2-2zm-6.5 12.5c-1.2 0-2.2-1-2.2-2.2s1-2.2 2.2-2.2 2.2 1 2.2 2.2-1 2.2-2.2 2.2zm-6 0c-1.2 0-2.2-1-2.2-2.2s1-2.2 2.2-2.2 2.2 1 2.2 2.2-1 2.2-2.2 2.2z"/>
                                            </svg>
                                        </span>
                                        <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">{{ channel.channel_name }}</span>
                                        {% if channel.is_default %}
                                            <span class="chip-badge">Default</span>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            —
                        {% endif %}
                    </td>
                    <td>
                        {% if user.is_active %}
                            <span class="badge-pill badge-active">Active</span>
                        {% else %}
                            <span class="badge-pill badge-inactive">Inactive</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user.is_superuser %}
                            <span class="badge-pill badge-superuser">Superuser</span>
                        {% elif user.is_staff %}
                            <span class="badge-pill badge-admin">Admin</span>
                        {% else %}
                            <span class="badge-pill badge-user">User</span>
                        {% endif %}
                    </td>
                    <td style="color: rgba(232, 236, 255, 0.70); font-weight: 700;">{{ user.date_joined|date:"M d, Y" }}</td>
                    <td style="text-align:right;">
                        <div class="um-actions">
                            <a class="icon-btn" href="{% url 'user_edit' user.id %}" title="Edit">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
                                    <path fill="currentColor" d="M3 17.25V21h3.75L17.8 9.95l-3.75-3.75L3 17.25zm2.92 2.83H5v-.92l8.06-8.06.92.92L5.92 20.08zM20.71 7.04a1 1 0 0 0 0-1.41L18.37 3.29a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                </svg>
                            </a>

                            {% if user.id != request.user.id %}
                            <form method="post" action="{% url 'user_delete' user.id %}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete user {{ user.username }}?');">
                                {% csrf_token %}
                                <button class="icon-btn danger" type="submit" title="Delete">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
                                        <path fill="currentColor" d="M9 3h6l1 2h4a1 1 0 1 1 0 2h-1l-1.2 14.1A2 2 0 0 1 14.8 23H9.2a2 2 0 0 1-2-1.9L6 7H5a1 1 0 1 1 0-2h4l1-2zm0 6a1 1 0 0 1 1 1v9a1 1 0 1 1-2 0v-9a1 1 0 0 1 1-1zm6 0a1 1 0 0 1 1 1v9a1 1 0 1 1-2 0v-9a1 1 0 0 1 1-1z"/>
                                    </svg>
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="um-footer">
            <div>Showing <strong style="color:#e8ecff;">{{ page_obj.start_index }}-{{ page_obj.end_index }}</strong> of <strong style="color:#e8ecff;">{{ page_obj.paginator.count }}</strong> users</div>
            <div class="um-pager">
                {% if page_obj.has_previous %}
                    <a class="pager-btn" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if role_filter and role_filter != 'all' %}&role={{ role_filter }}{% endif %}" aria-label="Previous page">
                        ‹
                    </a>
                {% else %}
                    <span class="pager-btn disabled" aria-hidden="true">‹</span>
                {% endif %}

                <div class="page-pill">{{ page_obj.number }}</div>

                {% if page_obj.has_next %}
                    <a class="pager-btn" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if role_filter and role_filter != 'all' %}&role={{ role_filter }}{% endif %}" aria-label="Next page">
                        ›
                    </a>
                {% else %}
                    <span class="pager-btn disabled" aria-hidden="true">›</span>
                {% endif %}
            </div>
        </div>
    </div>
    {% else %}
    <div class="um-table-card" style="padding: 28px; color: rgba(232,236,255,0.65);">
        No users found{% if search_query %} matching "{{ search_query }}"{% endif %}.
    </div>
    {% endif %}
</div>
{% endblock %}

