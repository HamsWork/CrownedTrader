{% extends 'signals/base.html' %}

{% block extra_css %}
<style>
    .form-container {
        max-width: 800px;
        margin: 0 auto;
    }

    .form-group {
        margin-bottom: 25px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 600;
        font-size: 1.05em;
    }
    
    /* For checkbox inputs, adjust label display */
    .form-group:has(.form-checkbox) {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .form-group:has(.form-checkbox) label {
        margin-bottom: 0;
        font-weight: normal;
        cursor: pointer;
    }

    .form-input, .form-textarea, .form-select {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1em;
        transition: all 0.3s;
        font-family: inherit;
    }

    .form-input:focus, .form-textarea:focus, .form-select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-textarea {
        resize: vertical;
    }

    .form-checkbox {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }

    .btn-submit {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 40px;
        border: none;
        border-radius: 8px;
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-submit:active {
        transform: translateY(0);
    }

    .recent-signals {
        margin-top: 40px;
        padding-top: 40px;
        border-top: 2px solid #f0f0f0;
    }

    .recent-signals h2 {
        color: #333;
        margin-bottom: 20px;
        font-size: 1.8em;
    }

    .signal-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 15px;
        border-left: 4px solid #667eea;
        transition: all 0.3s;
    }

    .signal-card:hover {
        transform: translateX(5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .signal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .signal-ticker {
        font-size: 1.3em;
        font-weight: 700;
        color: #333;
    }

    .signal-badge {
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 600;
    }

    .badge-entry {
        background: #d4edda;
        color: #155724;
    }

    .badge-stop_loss {
        background: #f8d7da;
        color: #721c24;
    }

    .badge-take_profit {
        background: #d1ecf1;
        color: #0c5460;
    }

    .signal-info {
        color: #666;
        font-size: 0.95em;
        margin-top: 10px;
        white-space: pre-wrap;
    }

    .signal-time {
        color: #999;
        font-size: 0.85em;
    }
</style>
{% endblock %}

{% block content %}
<div class="form-container">
    <h2 style="color: #333; margin-bottom: 30px; font-size: 2em;">üìù Submit New Signal</h2>
    
    <form method="post" id="signalForm">
        {% csrf_token %}
        
        <!-- Signal Type FIRST -->
        <div class="form-group">
            <label for="{{ form.signal_type.id_for_label }}">Signal Type *</label>
            {{ form.signal_type }}
            {% if form.signal_type.errors %}
                <div style="color: #dc3545; margin-top: 5px; font-size: 0.9em;">{{ form.signal_type.errors }}</div>
            {% endif %}
        </div>

        <!-- Dynamic Form Fields Container -->
        <div id="dynamicFields"></div>

        <!-- Hidden field for data -->
        <input type="hidden" name="data" id="id_data" value="{}" />
        {% if form.data.errors %}
            <div style="color: #dc3545; margin-top: 10px; margin-bottom: 10px; padding: 10px; background-color: #f8d7da; border-radius: 5px; font-size: 0.9em;">
                {{ form.data.errors }}
            </div>
        {% endif %}
        {% if form.non_field_errors %}
            <div style="color: #dc3545; margin-top: 10px; margin-bottom: 10px; padding: 10px; background-color: #f8d7da; border-radius: 5px; font-size: 0.9em;">
                {{ form.non_field_errors }}
            </div>
        {% endif %}

        <div style="text-align: center; margin-top: 30px;">
            <button type="submit" class="btn-submit">üöÄ Submit Signal</button>
        </div>
    </form>

    {% if recent_signals %}
    <div class="recent-signals">
        <h2>üìä Recent Signals</h2>
        {% for signal in recent_signals %}
        <div class="signal-card">
            <div class="signal-header">
                <span class="signal-ticker">{{ signal.data.ticker }}</span>
                <span class="signal-badge badge-{{ signal.signal_type.name|lower|slugify }}">
                    {{ signal.signal_type.name }}
                </span>
            </div>
            <div class="signal-info">
                <strong>Strike:</strong> {{ signal.data.strike }} | <strong>Expiration:</strong> {{ signal.data.expiration }}
            </div>
            {% if signal.data.extra_info %}
            <div class="signal-info">
                <strong>Extra:</strong> {{ signal.data.extra_info|truncatewords:20 }}
            </div>
            {% endif %}
            <div class="signal-time">{{ signal.created_at|date:"M d, Y H:i" }}</div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// Store signal types data
const signalTypesData = {
    {% for st in signal_types_data %}
    {{ st.id }}: {{ st.variables|safe }},
    {% endfor %}
};

// Map variable types to input field types
function getInputType(variableType) {
    const typeMap = {
        'string': 'text',
        'number': 'number',
        'float': 'number',
        'date': 'date',
        'text': 'textarea',
        'boolean': 'checkbox'
    };
    return typeMap[variableType] || 'text';
}

// Get label from variable or fall back to default
function getLabel(variable) {
    // If variable has a label property, use it
    if (variable.label) {
        return variable.label;
    }
    // Otherwise, capitalize the name
    const name = variable.name || variable;
    return name.charAt(0).toUpperCase() + name.slice(1).replace(/_/g, ' ');
}

// Create dynamic form fields based on signal type
function createDynamicFields(signalTypeId) {
    const dynamicFieldsContainer = document.getElementById('dynamicFields');
    dynamicFieldsContainer.innerHTML = '';
    
    const variables = signalTypesData[signalTypeId];
    if (!variables) {
        return;
    }
    
    variables.forEach(variable => {
        const formGroup = document.createElement('div');
        formGroup.className = 'form-group';
        
        const label = document.createElement('label');
        const isRequired = variable.required === true;
        label.textContent = getLabel(variable) + (isRequired ? ' *' : '');
        label.setAttribute('for', `id_${variable.name}`);
        
        let input;
        
        const inputType = getInputType(variable.type);
        
        // Handle select type (dropdown)
        if (variable.type === 'select' && variable.options) {
            input = document.createElement('select');
            input.className = 'form-select';
            
            // Add options directly (no default placeholder)
            variable.options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                if (variable.default && option === variable.default) {
                    optionElement.selected = true;
                }
                input.appendChild(optionElement);
            });
        } else {
            if (inputType === 'textarea') {
                input = document.createElement('textarea');
                input.className = 'form-textarea';
                input.rows = 3;
                // input.placeholder = 'Additional information (optional)';
            } else if (inputType === 'checkbox') {
                // Handle boolean/checkbox
                input = document.createElement('input');
                input.type = 'checkbox';
                input.className = 'form-checkbox';
                input.checked = variable.default || false;
            } else {
                input = document.createElement('input');
                input.className = 'form-input';
                input.type = inputType;
                
                // For float inputs, add step attribute to allow decimals
                if (variable.type === 'float') {
                    input.step = '0.01';
                }
                
                // Add placeholders
                const placeholders = {
                    'ticker': 'Enter ticker (e.g., AAPL, TSLA)',
                    'strike': 'Enter strike price (e.g., 150.50)',
                    'expiration': 'Enter expiration date (e.g., 2025-11-20)',
                    'price': 'Enter price (e.g., 1.25)',
                    'entry_price': 'Enter entry price (e.g., 1.25)',
                    'exit_price': 'Enter exit price (e.g., 1.50)',
                    'pnl_percent': 'Enter P&L % (e.g., 20.5)'
                };
                input.placeholder = placeholders[variable.name] || '';
            }
        }
        
        input.id = `id_${variable.name}`;
        input.name = variable.name;
        
        // Add HTML5 required attribute if field is required
        if (isRequired) {
            input.required = true;
            // Store that it was originally required for restoration
            input.setAttribute('data-originally-required', 'true');
        }
        
        // Add hint as placeholder if provided (overrides default placeholders)
        if (variable.hint && input.type !== 'checkbox') {
            input.placeholder = variable.hint;
        }
        
        // Add data attribute for conditional visibility based on is_shares
        if (variable.name === 'strike' || variable.name === 'expiration' || variable.name === 'option_type') {
            formGroup.setAttribute('data-requires-options', 'true');
        }
        
        // For checkboxes, append input first then label
        if (variable.type === 'boolean' || inputType === 'checkbox') {
            formGroup.appendChild(input);
            formGroup.appendChild(label);
        } else {
            formGroup.appendChild(label);
            formGroup.appendChild(input);
        }
        dynamicFieldsContainer.appendChild(formGroup);
    });
    
    // Set up is_shares checkbox handler
    const isSharesCheckbox = document.getElementById('id_is_shares');
    if (isSharesCheckbox) {
        isSharesCheckbox.addEventListener('change', function() {
            toggleOptionFields(this.checked);
        });
        // Initialize on page load
        toggleOptionFields(isSharesCheckbox.checked);
    }
}

// Toggle visibility of option-related fields based on is_shares checkbox
function toggleOptionFields(isShares) {
    const optionFields = document.querySelectorAll('[data-requires-options="true"]');
    optionFields.forEach(field => {
        if (isShares) {
            field.style.display = 'none';
            const input = field.querySelector('input, select');
            if (input) {
                input.removeAttribute('required');
                input.value = '';
            }
        } else {
            field.style.display = 'block';
            const input = field.querySelector('input, select');
            if (input && input.hasAttribute('data-originally-required')) {
                input.setAttribute('required', true);
            }
        }
    });
}

// Handle signal type change
document.addEventListener('DOMContentLoaded', function() {
    const signalTypeSelect = document.querySelector('select[name="signal_type"]');
    const form = document.getElementById('signalForm');
    
    if (signalTypeSelect) {
        // Initial load - always create fields for the first/default value
        const defaultValue = signalTypeSelect.value || Object.keys(signalTypesData)[0];
        if (defaultValue) {
            signalTypeSelect.value = defaultValue;
            createDynamicFields(defaultValue);
        }
        
        // Handle change
        signalTypeSelect.addEventListener('change', function() {
            createDynamicFields(this.value);
        });
        
        // Handle form submission
        form.addEventListener('submit', function(e) {
            // Get current signal type and its variables
            const currentSignalTypeId = signalTypeSelect.value;
            const currentVariables = signalTypesData[currentSignalTypeId] || [];
            
            // Validate required fields
            const dynamicInputs = document.querySelectorAll('#dynamicFields input, #dynamicFields textarea, #dynamicFields select');
            const errors = [];
            
            // Check if is_shares is checked
            const isSharesCheckbox = document.getElementById('id_is_shares');
            const isShares = isSharesCheckbox && isSharesCheckbox.checked;
            
            dynamicInputs.forEach(input => {
                // Skip validation if field is hidden due to is_shares
                if (input.closest('[data-requires-options="true"]') && isShares) {
                    return;
                }
                
                // Find the variable definition for this input
                const variable = currentVariables.find(v => v.name === input.name);
                
                // Check if field is required
                if (variable && variable.required === true) {
                    let isEmpty = false;
                    
                    // Check if field is empty based on type
                    if (input.type === 'checkbox') {
                        isEmpty = !input.checked;
                    } else {
                        isEmpty = !input.value || input.value.trim() === '';
                    }
                    
                    if (isEmpty) {
                        errors.push(variable.label || variable.name);
                        // Add error styling to the field
                        input.style.borderColor = '#dc3545';
                        const formGroup = input.closest('.form-group');
                        if (formGroup) {
                            formGroup.style.marginBottom = '10px';
                        }
                    } else {
                        // Remove error styling if field is valid
                        input.style.borderColor = '';
                    }
                } else {
                    // Remove error styling for non-required fields
                    input.style.borderColor = '';
                }
            });
            
            // Show errors if any and prevent submission
            if (errors.length > 0) {
                e.preventDefault();
                alert('Please fill in the following required fields:\n' + errors.map(e => '  ‚Ä¢ ' + e).join('\n'));
                return false;
            }
            
            // Collect all dynamic field values into a JSON object
            const signalData = {};
            dynamicInputs.forEach(input => {
                // Handle checkbox
                if (input.type === 'checkbox') {
                    signalData[input.name] = input.checked ? 'true' : 'false';
                } else {
                    signalData[input.name] = input.value;
                }
            });
            
            // Set the data field value
            const dataInput = form.querySelector('input[name="data"]');
            if (dataInput) {
                dataInput.value = JSON.stringify(signalData);
            } else {
                // If data field doesn't exist, add it to the form
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'data';
                hiddenInput.value = JSON.stringify(signalData);
                form.appendChild(hiddenInput);
            }
            
            // Let form submit naturally if validation passes
        });
    }
});
</script>
{% endblock %}

