{% extends 'signals/base.html' %}

{% block title %}My Profile - Crowned Trader Dashboard{% endblock %}

{% block breadcrumbs %}
<a href="{% url 'dashboard' %}">Dashboard</a>
<span>/</span>
<span>My Profile</span>
{% endblock %}

{% block extra_css %}
<style>
    .mp-page {
        width: 100%;
        max-width: 1840px;
        margin: 0 auto;
    }

    .mp-header {
        margin-bottom: 20px;
    }

    .mp-header h1 {
        margin: 0 0 8px 0;
        color: #e8ecff;
        font-size: 2.2em;
        font-weight: 800;
    }

    .mp-header p {
        margin: 0;
        color: rgba(232, 236, 255, 0.65);
        font-size: 1.05em;
    }

    .mp-grid {
        display: grid;
        grid-template-columns: minmax(0, 1fr) 360px;
        gap: 26px;
        align-items: start;
    }

    .card {
        background: rgba(15, 23, 42, 0.72);
        border: 1px solid rgba(42, 55, 95, 0.55);
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 10px 26px rgba(0, 0, 0, 0.22);
    }

    .card-body {
        padding: 18px;
    }

    .card-divider {
        height: 1px;
        background: rgba(255, 255, 255, 0.08);
        margin: 16px 0;
    }

    .profile-head {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 18px;
    }

    .avatar {
        width: 58px;
        height: 58px;
        border-radius: 50%;
        background: radial-gradient(circle at 30% 30%, rgba(var(--accent-rgb), 0.35), rgba(147, 51, 234, 0.20));
        border: 2px solid rgba(var(--accent-rgb), 0.35);
        box-shadow: 0 12px 26px rgba(0, 0, 0, 0.30);
        display: grid;
        place-items: center;
        color: #0b1020;
        font-weight: 900;
        font-size: 1.1em;
        flex: 0 0 auto;
    }

    .profile-name {
        margin: 0;
        color: #e8ecff;
        font-weight: 900;
        font-size: 1.15em;
        line-height: 1.1;
    }

    .profile-sub {
        margin: 6px 0 0 0;
        color: rgba(232, 236, 255, 0.60);
        font-weight: 600;
        font-size: 0.92em;
    }

    .badge-row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 10px;
    }

    .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid rgba(42, 55, 95, 0.55);
        background: rgba(255, 255, 255, 0.04);
        font-weight: 800;
        font-size: 0.85em;
        color: rgba(232, 236, 255, 0.78);
        width: fit-content;
    }

    .pill .dot {
        width: 7px;
        height: 7px;
        border-radius: 50%;
        background: rgba(232, 236, 255, 0.35);
    }

    .pill.active {
        color: rgba(52, 211, 153, 0.95);
        border-color: rgba(16, 185, 129, 0.35);
        background: rgba(16, 185, 129, 0.10);
    }

    .pill.active .dot {
        background: rgba(16, 185, 129, 0.95);
    }

    .pill.role {
        color: var(--accent);
        border-color: rgba(var(--accent-rgb), 0.45);
        background: rgba(var(--accent-rgb), 0.10);
    }

    .section-title {
        margin: 0 0 14px 0;
        color: rgba(232, 236, 255, 0.85);
        font-weight: 900;
        letter-spacing: 0.06em;
        font-size: 0.9em;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    .form-grid.one-col {
        grid-template-columns: 1fr;
    }

    .field label {
        display: block;
        margin-bottom: 8px;
        color: rgba(232, 236, 255, 0.85);
        font-weight: 700;
        font-size: 0.95em;
    }

    .input {
        width: 100%;
        height: 44px;
        border-radius: 12px;
        border: 1px solid rgba(42, 55, 95, 0.65);
        background: rgba(10, 16, 35, 0.72);
        color: #e8ecff;
        padding: 0 14px;
        font-weight: 600;
        transition: border-color 180ms ease, box-shadow 180ms ease;
    }

    .input:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(var(--accent-rgb), 0.10);
    }

    .discord-box {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 14px;
        border-radius: 14px;
        border: 1px solid rgba(42, 55, 95, 0.55);
        background: rgba(10, 16, 35, 0.55);
    }

    .discord-left {
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 0;
    }

    .discord-icon {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        background: rgba(88, 101, 242, 0.18);
        border: 1px solid rgba(88, 101, 242, 0.35);
        display: grid;
        place-items: center;
        flex: 0 0 auto;
        color: rgba(197, 204, 255, 0.95);
    }

    .discord-icon svg {
        width: 18px;
        height: 18px;
        display: block;
    }

    .discord-name {
        color: #e8ecff;
        font-weight: 800;
        margin: 0;
        font-size: 0.95em;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .discord-sub {
        color: rgba(232, 236, 255, 0.55);
        font-size: 0.85em;
        margin: 4px 0 0 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .link-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        color: rgba(147, 197, 253, 0.90);
        font-weight: 800;
        font-size: 0.9em;
        white-space: nowrap;
    }

    .link-btn svg {
        width: 16px;
        height: 16px;
        display: block;
    }

    .save-row {
        display: flex;
        justify-content: flex-end;
        margin-top: 14px;
    }

    .save-btn {
        background: var(--accent);
        color: #0b1020;
        border: none;
        border-radius: 12px;
        height: 44px;
        padding: 0 18px;
        font-weight: 900;
        cursor: pointer;
        box-shadow: 0 10px 26px rgba(var(--accent-rgb), 0.18);
        transition: transform 160ms ease, box-shadow 160ms ease, background 160ms ease;
    }

    .save-btn:hover {
        transform: translateY(-1px);
        background: color-mix(in srgb, var(--accent) 85%, #ffffff 15%);
        box-shadow: 0 14px 30px rgba(var(--accent-rgb), 0.22);
    }

    .stat-title {
        margin: 0;
        color: rgba(232, 236, 255, 0.85);
        font-weight: 900;
        font-size: 0.9em;
        letter-spacing: 0.08em;
    }

    .stat-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 12px;
        color: rgba(232, 236, 255, 0.65);
        font-weight: 700;
    }

    .stat-row .val {
        color: #e8ecff;
        font-weight: 900;
    }

    .stat-row .val.accent {
        color: var(--accent);
    }

    .activity-item {
        display: flex;
        gap: 10px;
        margin-top: 12px;
        align-items: flex-start;
    }

    .activity-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-top: 6px;
        flex: 0 0 auto;
        background: rgba(232, 236, 255, 0.35);
    }

    .activity-dot.yellow { background: var(--accent); }
    .activity-dot.green { background: rgba(16, 185, 129, 0.95); }
    .activity-dot.blue { background: rgba(59, 130, 246, 0.95); }

    .activity-text {
        color: rgba(232, 236, 255, 0.78);
        font-weight: 800;
        margin: 0;
        font-size: 0.92em;
    }

    .activity-sub {
        margin: 4px 0 0 0;
        color: rgba(232, 236, 255, 0.55);
        font-size: 0.85em;
    }

    .security-head {
        display: flex;
        align-items: center;
        gap: 12px;
        margin: 0;
        color: #e8ecff;
        font-weight: 900;
        font-size: 1.05em;
    }

    .security-head .lock {
        width: 32px;
        height: 32px;
        border-radius: 10px;
        background: rgba(var(--accent-rgb), 0.12);
        border: 1px solid rgba(var(--accent-rgb), 0.35);
        display: grid;
        place-items: center;
        color: var(--accent);
        flex: 0 0 auto;
    }

    .security-head .lock svg {
        width: 16px;
        height: 16px;
        display: block;
    }

    .security-sub {
        margin: 4px 0 0 44px;
        color: rgba(232, 236, 255, 0.60);
        font-size: 0.9em;
        font-weight: 600;
    }

    .security-actions {
        margin-top: 16px;
        display: flex;
        justify-content: flex-start;
    }

    .sec-btn {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(42, 55, 95, 0.55);
        color: rgba(232, 236, 255, 0.92);
        border-radius: 12px;
        height: 40px;
        padding: 0 16px;
        font-weight: 900;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: background 160ms ease, border-color 160ms ease, transform 160ms ease;
    }

    .sec-btn:hover {
        background: rgba(255, 255, 255, 0.09);
        border-color: rgba(42, 55, 95, 0.85);
        transform: translateY(-1px);
    }

    .mp-help {
        margin-top: 8px;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid rgba(42, 55, 95, 0.55);
        background: rgba(10, 16, 35, 0.55);
        color: rgba(232, 236, 255, 0.68);
        font-size: 0.88em;
        font-weight: 650;
        line-height: 1.4;
    }

    .mp-help ul {
        margin: 0;
        padding-left: 18px;
    }

    .mp-help li {
        margin: 6px 0 0 0;
    }

    .mp-help li:first-child {
        margin-top: 0;
    }

    .field-error {
        margin-top: 6px;
        color: rgba(248, 113, 113, 0.95);
        font-size: 0.86em;
        font-weight: 700;
    }

    .field-error ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .field-error li {
        margin: 0;
    }

    .error-banner {
        margin-top: 12px;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid rgba(248, 113, 113, 0.35);
        background: rgba(248, 113, 113, 0.10);
        color: rgba(255, 220, 220, 0.92);
        font-weight: 800;
        font-size: 0.9em;
    }

    @media (max-width: 980px) {
        .mp-grid {
            grid-template-columns: 1fr;
        }
        .form-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="mp-page">
    <div class="mp-header">
        <h1>My Profile</h1>
        <p>Manage your personal account information and security settings.</p>
    </div>

    <div class="mp-grid">
        <!-- Left column -->
        <div>
            <div class="card">
                <div class="profile-head">
                    <div class="avatar">{{ request.user.get_full_name|default:request.user.username|first|upper }}</div>
                    <div style="min-width:0;">
                        <h3 class="profile-name">{{ request.user.get_full_name|default:request.user.username }}</h3>
                        <div class="profile-sub">{% if request.user.is_superuser %}Administrator{% else %}Lead Trader{% endif %}</div>
                        <div class="badge-row">
                            <span class="pill active"><span class="dot"></span> Active</span>
                            <span class="pill role">{% if request.user.is_superuser %}Superuser{% else %}User{% endif %}</span>
                        </div>
                    </div>
                </div>

                <div class="card-divider"></div>

                <div class="card-body">
                    <div class="section-title">ACCOUNT DETAILS</div>
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="update_email">
                        <div class="form-grid one-col">
                            <div class="field">
                                <label for="email">Email Address</label>
                                <input class="input" type="email" id="email" name="email" value="{{ email_value|default:request.user.email }}" required>
                            </div>
                        </div>

                        <div style="margin-top: 18px;">
                            <div class="section-title">CONNECTED DISCORD ACCOUNT</div>
                            <div class="discord-box">
                                <div class="discord-left">
                                    <div class="discord-icon" aria-hidden="true">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                            <!-- Discord logo (simplified) -->
                                            <path fill="currentColor" d="M19.5 5.6c-1.4-1-2.8-1.2-2.8-1.2l-.3.3c1.7.5 2.5 1.3 2.5 1.3-1-.5-2-.9-2.9-1.1-.7-.2-1.4-.3-2.1-.3-1.2-.1-2.2.1-3.1.3-.5.1-1.1.3-1.7.5-.2.1-.4.2-.7.3-.1 0-.2.1-.3.1 0 0 .8-.8 2.6-1.3l-.2-.3s-1.4.2-2.8 1.2c0 0-1.4 2.4-1.4 5.4 0 0 .8 1.3 2.9 1.4 0 0 .4-.5.7-.9-1.4-.4-1.9-1.2-1.9-1.2.2.1.4.2.6.3.0 0 .1.1.2.1.0 0 .0 0 .1 0 .4.2.9.4 1.4.5.7.2 1.6.4 2.7.4 1.1 0 2-.2 2.7-.4.5-.1 1-.3 1.4-.5l.3-.2c.2-.1.4-.2.6-.3 0 0-.5.8-1.9 1.2.3.4.7.9.7.9 2.1-.1 2.9-1.4 2.9-1.4 0-3-1.4-5.4-1.4-5.4ZM9.4 11.2c-.6 0-1-.6-1-1.2s.5-1.2 1-1.2c.6 0 1 .6 1 1.2s-.5 1.2-1 1.2Zm5.2 0c-.6 0-1-.6-1-1.2s.5-1.2 1-1.2c.6 0 1 .6 1 1.2s-.5 1.2-1 1.2Z"/>
                                        </svg>
                                    </div>
                                    <div style="min-width:0;">
                                        <p class="discord-name">
                                            {% if default_channel %}{{ default_channel.channel_name }}{% else %}Not configured{% endif %}
                                        </p>
                                        <p class="discord-sub">
                                            {% if default_channel and default_channel.webhook_url %}
                                                Webhook: {{ default_channel.webhook_url|slice:":38" }}{% if default_channel.webhook_url|length > 38 %}...{% endif %}
                                            {% else %}
                                                No Discord webhook configured.
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="save-row">
                            <button type="submit" class="save-btn">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>

            <div style="margin-top: 18px;" class="card">
                <div class="card-body">
                    <div class="security-head">
                        <span class="lock" aria-hidden="true">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path fill="currentColor" d="M17 9h-1V7a4 4 0 0 0-8 0v2H7a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-8a2 2 0 0 0-2-2Zm-7-2a2 2 0 1 1 4 0v2h-4V7Zm7 12H7v-8h10v8Z"/>
                            </svg>
                        </span>
                        <span>Password &amp; Security</span>
                    </div>
                    <div class="security-sub">Manage your password and account security</div>

                    {% if password_form.non_field_errors %}
                        <div class="error-banner">
                            {% for err in password_form.non_field_errors %}{{ err }}{% endfor %}
                        </div>
                    {% endif %}

                    <form method="post" style="margin-top: 14px;">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="change_password">

                        <div class="form-grid" style="grid-template-columns: 1fr;">
                            <div class="field">
                                <label for="{{ password_form.old_password.id_for_label }}">{{ password_form.old_password.label }}</label>
                                <input class="input" type="password" id="{{ password_form.old_password.id_for_label }}" name="{{ password_form.old_password.name }}" autocomplete="current-password" required>
                                {% if password_form.old_password.errors %}
                                    <div class="field-error">
                                        <ul>
                                            {% for err in password_form.old_password.errors %}<li>{{ err }}</li>{% endfor %}
                                        </ul>
                                    </div>
                                {% endif %}
                            </div>

                            <div class="field">
                                <label for="{{ password_form.new_password1.id_for_label }}">{{ password_form.new_password1.label }}</label>
                                <input class="input" type="password" id="{{ password_form.new_password1.id_for_label }}" name="{{ password_form.new_password1.name }}" autocomplete="new-password" required>
                                {% if password_form.new_password1.errors %}
                                    <div class="field-error">
                                        <ul>
                                            {% for err in password_form.new_password1.errors %}<li>{{ err }}</li>{% endfor %}
                                        </ul>
                                    </div>
                                {% endif %}
                                {% if password_form.new_password1.help_text %}
                                    <div class="mp-help">{{ password_form.new_password1.help_text|safe }}</div>
                                {% endif %}
                            </div>

                            <div class="field">
                                <label for="{{ password_form.new_password2.id_for_label }}">{{ password_form.new_password2.label }}</label>
                                <input class="input" type="password" id="{{ password_form.new_password2.id_for_label }}" name="{{ password_form.new_password2.name }}" autocomplete="new-password" required>
                                {% if password_form.new_password2.errors %}
                                    <div class="field-error">
                                        <ul>
                                            {% for err in password_form.new_password2.errors %}<li>{{ err }}</li>{% endfor %}
                                        </ul>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="security-actions" style="margin-top: 14px;">
                            <button type="submit" class="sec-btn" style="cursor:pointer;">Update Password</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right column -->
        <div style="display:flex; flex-direction:column; gap: 18px;">
            <div class="card">
                <div class="card-body">
                    <div class="stat-title">ACCOUNT STATISTICS</div>
                    <div class="stat-row">
                        <span>Member Since</span>
                        <span class="val">{{ request.user.date_joined|date:"M Y" }}</span>
                    </div>
                    <div class="stat-row">
                        <span>Signals Created</span>
                        <span class="val accent">{{ signals_created|default:0 }}</span>
                    </div>
                    <div class="stat-row">
                        <span>Last Login</span>
                        <span class="val">{% if request.user.last_login %}{{ request.user.last_login|date:"M d, Y, g:i A" }}{% else %}—{% endif %}</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <div class="stat-title">RECENT ACTIVITY</div>
                    <div class="activity-item">
                        <span class="activity-dot yellow"></span>
                        <div>
                            <p class="activity-text">Updated profile information</p>
                            <p class="activity-sub">{% if request.user.last_login %}Last login {{ request.user.last_login|timesince }} ago{% else %}—{% endif %}</p>
                        </div>
                    </div>
                    <div class="activity-item">
                        <span class="activity-dot green"></span>
                        <div>
                            <p class="activity-text">Signals created</p>
                            <p class="activity-sub">{{ signals_created|default:0 }} total</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
